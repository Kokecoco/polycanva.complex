<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ—¥çµŒå¹³å‡ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ï¼ˆRapidAPIç‰ˆï¼‰</title>
<style>
  :root { --bg:#0b1220; --card:#151e2e; --accent:#ffd54d; --ok:#16c784; --ng:#ea3943; --muted:#9fb0ce; }
  body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; background:var(--bg); color:#fff; }
  .wrap { max-width:860px; margin:24px auto; padding:0 16px; }
  h1 { color:var(--accent); margin:0 0 8px; }
  .sub { color:var(--muted); margin-bottom:20px; }
  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:16px; }
  .card { background:var(--card); border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
  .price { font-size:28px; margin-top:6px; }
  .muted { color:var(--muted); font-size:13px; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  button { background:#2a61ff; border:none; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
  button:hover{ filter:brightness(1.05); }
  input[type="number"]{ width:100px; padding:8px; border-radius:8px; border:1px solid #39507a; background:#0f1626; color:#fff; }
  .stat { font-size:18px; }
  .pnl-pos { color:var(--ok); } .pnl-neg { color:var(--ng); }
  .log { max-height:220px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px; background:#0f1626; border-radius:10px; padding:10px; }
  .footer { margin-top:14px; font-size:12px; color:#88a; }
  .err { color:#ff9c9c; }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“ˆ æ—¥çµŒå¹³å‡ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </h1>
  <div class="sub">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: RapidAPI / YH Finance (yahoo-finance15) Â· 1åˆ†ã”ã¨è‡ªå‹•æ›´æ–°</div>

  <div class="grid">
    <div class="card">
      <div class="muted">ç¾åœ¨å€¤ï¼ˆNikkei 225 / ^N225ï¼‰</div>
      <div id="price" class="price">å–å¾—ä¸­â€¦</div>
      <div id="asof" class="muted">â€”</div>
      <div class="row" style="margin-top:12px; gap:8px;">
        <button id="refresh">æ‰‹å‹•ã§æ›´æ–°</button>
        <span id="status" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="muted">å£åº§æƒ…å ±</div>
      <div class="stat">æ®‹é«˜: <span id="balance">1,000,000</span> å††</div>
      <div class="stat">ä¿æœ‰: <span id="units">0</span> å˜ä½</div>
      <div class="stat">å¹³å‡å–å¾—å˜ä¾¡: <span id="avg">-</span></div>
      <div class="stat">è©•ä¾¡æç›Š: <span id="pnl">-</span></div>
    </div>

    <div class="card">
      <div class="muted">æ³¨æ–‡</div>
      <div class="row">
        æ•°é‡ <input id="qty" type="number" min="1" value="1"/>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="buy">è²·ã†</button>
        <button id="sell">å£²ã‚‹</button>
      </div>
      <div class="footer">â€» 1å˜ä½ = æŒ‡æ•°ã®ç¾åœ¨å€¤ã‚’ãã®ã¾ã¾æ¡ç”¨ï¼ˆå­¦ç¿’ç”¨ã®ç°¡æ˜“ãƒ¢ãƒ‡ãƒ«ï¼‰</div>
    </div>

    <div class="card">
      <div class="muted">ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</div>
      <div id="log" class="log"></div>
      <div class="footer">LocalStorageã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã«ç‹¬ç«‹ï¼‰ã€‚</div>
    </div>
  </div>

  <div class="footer" style="margin-top:14px;">
    å–å¾—ã«å¤±æ•—ã™ã‚‹å ´åˆã¯ <span class="err">APIã‚­ãƒ¼</span> ã¨ <span class="err">ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL</span> ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
  </div>
</div>

<script>
  // ====== è¨­å®šï¼ˆå¿…ãšå·®ã—æ›¿ãˆï¼‰ ======
  const API_KEY  = "48584f0adfmsh0b16f34621e2ec5p10dce1jsn5bd220891dad"; // â† RapidAPIã®ã‚­ãƒ¼ã‚’å…¥ã‚Œã‚‹
  const API_HOST = "yahoo-finance15.p.rapidapi.com";
  // æ­£ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ^N225 = Nikkei 225ï¼‰
  const QUOTE_URL = `https://${API_HOST}/api/yahoo/qu/quote/%5EN225`;

  // ====== çŠ¶æ…‹ ======
  const initialState = { balance: 1_000_000, units: 0, avgPrice: 0 };
  let state = loadState();
  let lastPrice = 0;

  // ====== è¦ç´  ======
  const el = {
    price:   document.getElementById('price'),
    asof:    document.getElementById('asof'),
    status:  document.getElementById('status'),
    balance: document.getElementById('balance'),
    units:   document.getElementById('units'),
    avg:     document.getElementById('avg'),
    pnl:     document.getElementById('pnl'),
    qty:     document.getElementById('qty'),
    buy:     document.getElementById('buy'),
    sell:    document.getElementById('sell'),
    refresh: document.getElementById('refresh'),
    log:     document.getElementById('log'),
  };

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function saveState(){ localStorage.setItem('nikkeiGame', JSON.stringify(state)); }
  function loadState(){
    try { return JSON.parse(localStorage.getItem('nikkeiGame')) || {...initialState}; }
    catch { return {...initialState}; }
  }
  function yen(x){ return (x ?? 0).toLocaleString('ja-JP'); }
  function log(msg){
    const p = document.createElement('div');
    const t = new Date().toLocaleTimeString('ja-JP');
    p.textContent = `[${t}] ${msg}`;
    el.log.prepend(p);
  }
  function setStatus(text, isError=false){
    el.status.textContent = text || '';
    el.status.style.color = isError ? '#ff9c9c' : '#9fb0ce';
  }

  function render(){
    el.balance.textContent = yen(Math.round(state.balance));
    el.units.textContent   = state.units;
    el.avg.textContent     = state.units ? yen(Math.round(state.avgPrice)) : '-';

    if (lastPrice && state.units){
      const pnl = (lastPrice - state.avgPrice) * state.units;
      el.pnl.textContent = `${pnl >= 0 ? '+' : ''}${yen(Math.round(pnl))} å††`;
      el.pnl.className = pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
    } else {
      el.pnl.textContent = '-';
      el.pnl.className = '';
    }
  }

  // ====== æ ªä¾¡å–å¾—ï¼ˆRapidAPI / yahoo-finance15ï¼‰ ======
  async function fetchPrice(){
    setStatus('æ›´æ–°ä¸­â€¦');
    try{
      const res = await fetch(QUOTE_URL, {
        headers: {
          'x-rapidapi-key': API_KEY,
          'x-rapidapi-host': API_HOST
        }
      });

      if (!res.ok){
        const text = await res.text();
        setStatus(`HTTP ${res.status}: ${text.slice(0,120)}â€¦`, true);
        log(`âš ï¸ å–å¾—å¤±æ•—ï¼ˆHTTP ${res.status})`);
        return null;
      }

      const json = await res.json();
      // è¿”å´å½¢ã¯APIã®ãƒ—ãƒ©ãƒ³ã«ã‚ˆã‚Š Object or Array ã®ã“ã¨ãŒã‚ã‚‹ã®ã§ä¸¡å¯¾å¿œ
      const item = Array.isArray(json) ? json[0] : json;

      // ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€™è£œ
      const price = Number(
        item?.regularMarketPrice ??
        item?.price ??
        item?.ask ??
        item?.bid ??
        NaN
      );

      // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å€™è£œ
      const tsSec = Number(
        item?.regularMarketTime ??
        item?.postMarketTime ??
        item?.preMarketTime ??
        item?.time ??
        0
      );
      const ts = tsSec ? new Date(tsSec * 1000) : new Date();

      if (!Number.isFinite(price)){
        setStatus('ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼šä¾¡æ ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
        log('âŒ ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼ˆpriceãªã—ï¼‰');
        return null;
      }

      lastPrice = price;
      el.price.textContent = `ç¾åœ¨å€¤: ${yen(price)} å††`;
      el.asof.textContent  = `æ™‚åˆ»: ${ts.toLocaleString('ja-JP')}`;
      setStatus('æ›´æ–°å®Œäº†');
      log(`ğŸ’¹ ä¾¡æ ¼æ›´æ–°: ${yen(price)} å††`);
      render();
      return price;

    } catch(err){
      setStatus('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼', true);
      console.error(err);
      log('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
      return null;
    }
  }

  // ====== å£²è²· ======
  async function ensurePrice(){ return lastPrice || await fetchPrice(); }

  async function buy(){
    const p = await ensurePrice();
    if (!p) return alert('ä¾¡æ ¼ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    const q = Math.max(1, parseInt(el.qty.value||'1',10));
    const cost = p * q;
    if (cost > state.balance) return alert('æ®‹é«˜ä¸è¶³ã§ã™ã€‚');

    const totalBefore = state.avgPrice * state.units;
    state.units += q;
    state.avgPrice = state.units ? (totalBefore + cost) / state.units : 0;
    state.balance -= cost;

    saveState(); render();
    log(`ğŸŸ¢ è²·ã„: å˜ä¾¡ ${yen(p)} å†† Ã— ${q} â†’ æ”¯å‡º ${yen(cost)} å††`);
  }

  async function sell(){
    const p = await ensurePrice();
    if (!p) return alert('ä¾¡æ ¼ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    const q = Math.max(1, parseInt(el.qty.value||'1',10));
    if (q > state.units) return alert('å£²å´æ•°é‡ãŒä¿æœ‰æ•°é‡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚');

    const revenue = p * q;
    state.units -= q;
    if (state.units === 0) state.avgPrice = 0;
    state.balance += revenue;

    saveState(); render();
    log(`ğŸ”´ å£²ã‚Š: å˜ä¾¡ ${yen(p)} å†† Ã— ${q} â†’ åå…¥ ${yen(revenue)} å††`);
  }

  // ====== ã‚¤ãƒ™ãƒ³ãƒˆ ======
  el.refresh.addEventListener('click', fetchPrice);
  el.buy.addEventListener('click', buy);
  el.sell.addEventListener('click', sell);

  // åˆæœŸæç”» & åˆå›å–å¾— & 1åˆ†ã”ã¨æ›´æ–°
  render();
  fetchPrice();
  setInterval(fetchPrice, 60 * 1000);
</script>
</body>
</html>
