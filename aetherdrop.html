<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether Drop (Debug Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #111; color: #eee; }
        h2 { color: #00d2ff; text-align: center; margin: 5px 0; }
        
        /* ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆç”»é¢ä¸Šã«ãƒ­ã‚°ã‚’å‡ºã™ï¼‰ */
        #console-area {
            background: #000; border: 1px solid #333; color: #0f0; font-family: monospace;
            font-size: 10px; height: 120px; overflow-y: scroll; padding: 5px;
            margin-bottom: 10px; border-radius: 4px;
        }
        .log-info { color: #0f0; }
        .log-warn { color: #ff0; }
        .log-error { color: #f00; font-weight: bold; }

        /* UIã‚³ãƒ³ãƒ†ãƒŠ */
        .container { max-width: 600px; margin: 0 auto; background: #222; padding: 15px; border-radius: 8px; }
        .hidden { display: none !important; }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn { width: 100%; padding: 12px; margin: 5px 0; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-gray { background: #666; color: white; }
        
        /* QRãƒ»ã‚«ãƒ¡ãƒ© */
        #qr-area { background: white; padding: 10px; display: inline-block; margin: 10px auto; border-radius: 5px; }
        #video-wrapper { position: relative; width: 100%; max-width: 400px; margin: 0 auto; border: 2px solid #00d2ff; border-radius: 5px; overflow: hidden;}
        video { width: 100%; display: block; }
        
        /* ã‚¬ã‚¤ãƒ‰ãƒ†ã‚­ã‚¹ãƒˆ */
        .guide { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #00d2ff; }
        .step-title { font-weight: bold; color: #00d2ff; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<!-- ç”»é¢ä¸Šãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
<div id="console-area"><div>[SYSTEM] Console Ready...</div></div>

<div class="container">
    <h2>Aether Drop âš¡</h2>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—0: å½¹å‰²é¸æŠ -->
    <div id="step-role">
        <div class="guide">
            <span class="step-title">Step 0: å½¹å‰²åˆ†æ‹…</span>
            ãƒ†ã‚¶ãƒªãƒ³ã‚°ã€ã¾ãŸã¯åŒã˜Wi-Fiã«æ¥ç¶šã—ã¦ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚
        </div>
        <button class="btn btn-blue" onclick="initSender()">ğŸ“¤ é€ä¿¡å´ (Sender)</button>
        <button class="btn btn-green" onclick="initReceiver()">ğŸ“¥ å—ä¿¡å´ (Receiver)</button>
    </div>

    <!-- é€ä¿¡å´ã‚¨ãƒªã‚¢ -->
    <div id="sender-ui" class="hidden">
        <!-- S1: è‡ªåˆ†ã®QRã‚’è¦‹ã›ã‚‹ -->
        <div id="sender-step1">
            <div class="guide">
                <span class="step-title">Step 1: QRã‚’è¦‹ã›ã‚‹</span>
                å—ä¿¡å´ã®ã‚¹ãƒãƒ›ã§ã€ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‰ã›ã¦ãã ã•ã„ã€‚
            </div>
            <div style="text-align:center;"><div id="sender-qr" id="qr-area"></div></div>
            <button class="btn btn-gray" onclick="senderToStep2()">ç›¸æ‰‹ãŒèª­ã¿å–ã£ãŸã‚‰ã“ã“ã‚’æŠ¼ã™ â–¼</button>
        </div>

        <!-- S2: ç›¸æ‰‹ã®è¿”äº‹ã‚’èª­ã‚€ -->
        <div id="sender-step2" class="hidden">
            <div class="guide">
                <span class="step-title">Step 2: è¿”äº‹ã‚’èª­ã¿å–ã‚‹</span>
                å—ä¿¡å´ã®ç”»é¢ã«å‡ºã¦ããŸQRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </div>
            <div id="video-wrapper-s">
                <video id="video-s" playsinline></video>
            </div>
            <textarea id="manual-input-s" placeholder="ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆãªã„å ´åˆã¯ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘" style="width:100%; height:40px; margin-top:5px;"></textarea>
            <button class="btn btn-gray" onclick="manualPaste('sender')">æ‰‹å‹•ã§æ¥ç¶š</button>
        </div>
    </div>

    <!-- å—ä¿¡å´ã‚¨ãƒªã‚¢ -->
    <div id="receiver-ui" class="hidden">
        <!-- R1: ç›¸æ‰‹ã®QRã‚’èª­ã‚€ -->
        <div id="receiver-step1">
            <div class="guide">
                <span class="step-title">Step 1: é€ä¿¡å´ã‚’ã‚¹ã‚­ãƒ£ãƒ³</span>
                é€ä¿¡å´ã®ç”»é¢ã«å‡ºã¦ã„ã‚‹QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚
            </div>
            <div id="video-wrapper-r">
                <video id="video-r" playsinline></video>
            </div>
             <textarea id="manual-input-r" placeholder="ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆãªã„å ´åˆã¯ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘" style="width:100%; height:40px; margin-top:5px;"></textarea>
            <button class="btn btn-gray" onclick="manualPaste('receiver')">æ‰‹å‹•ã§æ¥ç¶š</button>
        </div>

        <!-- R2: è‡ªåˆ†ã®è¿”äº‹ã‚’è¦‹ã›ã‚‹ -->
        <div id="receiver-step2" class="hidden">
            <div class="guide">
                <span class="step-title">Step 2: è¿”äº‹ã‚’ç›¸æ‰‹ã«è¦‹ã›ã‚‹</span>
                ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’<b>é€ä¿¡å´ã®ã‚«ãƒ¡ãƒ©</b>ã§èª­ã¿å–ã‚‰ã›ã¦ãã ã•ã„ã€‚
            </div>
            <div style="text-align:center; background:white; padding:10px; border-radius:5px;">
                <div id="receiver-qr"></div>
            </div>
            <p style="text-align:center;">ç›¸æ‰‹ãŒèª­ã¿å–ã‚‹ã¨è‡ªå‹•ã§æ¥ç¶šã•ã‚Œã¾ã™...</p>
        </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ã‚¨ãƒªã‚¢ (æ¥ç¶šå®Œäº†å¾Œ) -->
    <div id="transfer-ui" class="hidden">
        <h3 style="text-align:center; color:#0f0;">âœ… æ¥ç¶šå®Œäº†</h3>
        <div id="file-controls" class="hidden">
            <input type="file" id="fileInput" style="color:white;">
            <button class="btn btn-blue" onclick="sendFile()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡</button>
        </div>
        <div id="status-msg" style="margin-top:10px;">å¾…æ©Ÿä¸­...</div>
        <div id="progress-area" style="width:100%; background:#333; height:20px; margin-top:5px; display:none;">
            <div id="progress-bar" style="width:0%; background:#00d2ff; height:100%;"></div>
        </div>
        <div id="download-area"></div>
    </div>

</div>

<script>
    // --- 1. ç”»é¢ä¸Šã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ©Ÿèƒ½ (DevToolsä»£æ›¿) ---
    function log(msg, type = 'INFO') {
        const consoleDiv = document.getElementById('console-area');
        const line = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        line.textContent = `[${time}] ${type}: ${msg}`;
        
        if (type === 'ERROR') line.className = 'log-error';
        else if (type === 'WARN') line.className = 'log-warn';
        else line.className = 'log-info';

        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight; // æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        console.log(msg); // æœ¬ç‰©ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚ä¸€å¿œå‡ºã™
    }

    window.onerror = function(msg, url, line) {
        log(`${msg} (Line:${line})`, 'ERROR');
    };

    // --- å¤‰æ•° ---
    let pc;
    let dc;
    let role = '';
    const config = { iceServers: [] }; // ãƒ­ãƒ¼ã‚«ãƒ«é€šä¿¡å¼·åˆ¶

    // --- åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ ---
    function initSender() {
        role = 'sender';
        document.getElementById('step-role').classList.add('hidden');
        document.getElementById('sender-ui').classList.remove('hidden');
        log("é€ä¿¡å´ã¨ã—ã¦é–‹å§‹ã—ã¾ã—ãŸã€‚");

        pc = new RTCPeerConnection(config);
        setupPC(pc);
        
        // ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«ä½œæˆ
        dc = pc.createDataChannel("aether");
        setupDC(dc);

        pc.createOffer().then(offer => {
            return pc.setLocalDescription(offer);
        }).catch(e => log("Offerä½œæˆå¤±æ•—: " + e, 'ERROR'));
    }

    function initReceiver() {
        role = 'receiver';
        document.getElementById('step-role').classList.add('hidden');
        document.getElementById('receiver-ui').classList.remove('hidden');
        log("å—ä¿¡å´ã¨ã—ã¦é–‹å§‹ã—ã¾ã—ãŸã€‚");
        
        pc = new RTCPeerConnection(config);
        setupPC(pc);

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«å—ä¿¡å¾…æ©Ÿ
        pc.ondatachannel = e => {
            log("ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«ã‚’å—ä¿¡ã—ã¾ã—ãŸï¼");
            setupDC(e.channel);
        };

        // ã„ããªã‚Šã‚«ãƒ¡ãƒ©èµ·å‹•
        startScan('video-r', 'receiver');
    }

    // --- PCå…±é€šè¨­å®š ---
    function setupPC(peer) {
        peer.onicecandidate = e => {
            if (e.candidate === null) {
                log("ICEåé›†å®Œäº†ã€‚SDPã‚’QRåŒ–ã—ã¾ã™ã€‚");
                const sdp = JSON.stringify(peer.localDescription);
                const compressed = LZString.compressToBase64(sdp);
                
                if (role === 'sender') {
                    showQR('sender-qr', compressed);
                } else {
                    showQR('receiver-qr', compressed);
                }
            }
        };

        peer.onconnectionstatechange = () => {
            log(`æ¥ç¶šçŠ¶æ…‹å¤‰æ›´: ${peer.connectionState}`);
            if (peer.connectionState === 'connected') {
                log("â˜… P2Pæ¥ç¶šæˆåŠŸï¼");
                document.getElementById('sender-ui').classList.add('hidden');
                document.getElementById('receiver-ui').classList.add('hidden');
                document.getElementById('transfer-ui').classList.remove('hidden');
                if(role === 'sender') document.getElementById('file-controls').classList.remove('hidden');
            }
        };
        
        peer.oniceconnectionstatechange = () => {
            log(`ICEçŠ¶æ…‹: ${peer.iceConnectionState}`);
        }
    }

    // --- ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«è¨­å®š ---
    function setupDC(channel) {
        dc = channel;
        dc.onopen = () => log("ãƒãƒ£ãƒãƒ«ã‚ªãƒ¼ãƒ—ãƒ³: ãƒ‡ãƒ¼ã‚¿é€ä¿¡å¯èƒ½");
        dc.onmessage = handleMessage;
    }

    // --- Senderã®ã‚¹ãƒ†ãƒƒãƒ—é·ç§» ---
    function senderToStep2() {
        document.getElementById('sender-step1').classList.add('hidden');
        document.getElementById('sender-step2').classList.remove('hidden');
        startScan('video-s', 'sender');
    }

    // --- QRè¡¨ç¤º ---
    function showQR(elemId, text) {
        const el = document.getElementById(elemId);
        el.innerHTML = "";
        el.style.background = "white"; 
        try {
            new QRCode(el, { text: text, width: 200, height: 200 });
            log(`${elemId} ã«QRã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚æ–‡å­—æ•°:${text.length}`);
        } catch(e) {
            log("QRç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + e, 'ERROR');
        }
    }

    // --- ã‚«ãƒ¡ãƒ© & ã‚¹ã‚­ãƒ£ãƒ³ ---
    let videoStream = null;
    
    function startScan(videoId, mode) {
        log(`${mode}ç”¨ã®ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¾ã™...`);
        const video = document.getElementById(videoId);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                video.play();
                requestAnimationFrame(tick);
            })
            .catch(e => {
                log("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + e.name + " " + e.message, 'ERROR');
                alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã€‚HTTPSæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            });

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code) {
                    log("QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºï¼");
                    handleScannedData(code.data, mode);
                    // æˆåŠŸã—ãŸã‚‰ã‚«ãƒ¡ãƒ©åœæ­¢
                    if(videoStream) videoStream.getTracks().forEach(t => t.stop());
                    return;
                }
            }
            if(videoStream && videoStream.active) requestAnimationFrame(tick);
        }
    }

    // --- èª­ã¿å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç† (Offer/Answeré©ç”¨) ---
    function handleScannedData(data, mode) {
        try {
            const sdpStr = LZString.decompressFromBase64(data);
            if(!sdpStr) throw new Error("è§£å‡å¤±æ•—");
            const desc = JSON.parse(sdpStr);
            log(`${desc.type} ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚é©ç”¨ã—ã¾ã™ã€‚`);

            pc.setRemoteDescription(desc).then(() => {
                if (desc.type === 'offer') {
                    // Receiver: Offerã‚’å—ã‘å–ã£ãŸã®ã§Answerã‚’ä½œã‚‹
                    log("Answerã‚’ä½œæˆä¸­...");
                    return pc.createAnswer().then(answer => pc.setLocalDescription(answer));
                }
            }).then(() => {
                if (desc.type === 'offer') {
                    // Receiver: Step1(ã‚«ãƒ¡ãƒ©) -> Step2(QRè¡¨ç¤º)ã¸
                    document.getElementById('receiver-step1').classList.add('hidden');
                    document.getElementById('receiver-step2').classList.remove('hidden');
                    log("Answerç”Ÿæˆå®Œäº†ã€‚ICEåé›†ä¸­...");
                } else {
                    log("Answeré©ç”¨å®Œäº†ã€‚æ¥ç¶šç¢ºç«‹å¾…ã¡...");
                }
            }).catch(e => log("SDPå‡¦ç†ã‚¨ãƒ©ãƒ¼: " + e, 'ERROR'));

        } catch(e) {
            log("ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šå¤±æ•—: " + e, 'ERROR');
        }
    }
    
    function manualPaste(mode) {
        const id = mode === 'sender' ? 'manual-input-s' : 'manual-input-r';
        const val = document.getElementById(id).value;
        if(val) handleScannedData(val, mode);
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ãƒ­ã‚¸ãƒƒã‚¯ ---
    let incomingInfo = null;
    let incomingBuffer = [];
    let receivedBytes = 0;

    function sendFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;
        
        log(`é€ä¿¡é–‹å§‹: ${file.name} (${file.size} bytes)`);
        dc.send(JSON.stringify({ meta: true, name: file.name, size: file.size }));
        
        const chunkSize = 16384;
        let offset = 0;
        const reader = new FileReader();
        
        reader.onload = e => {
            dc.send(e.target.result); // ArrayBufferé€ä¿¡
            offset += e.target.result.byteLength;
            updateProgress(offset, file.size);
            
            if (offset < file.size) {
                readSlice(offset);
            } else {
                log("é€ä¿¡å®Œäº†ï¼");
            }
        };

        function readSlice(o) {
            const slice = file.slice(o, o + chunkSize);
            reader.readAsArrayBuffer(slice);
        }
        readSlice(0);
    }

    function handleMessage(event) {
        const data = event.data;
        if (typeof data === 'string') {
            const msg = JSON.parse(data);
            if (msg.meta) {
                incomingInfo = msg;
                incomingBuffer = [];
                receivedBytes = 0;
                log(`å—ä¿¡é–‹å§‹: ${msg.name}`);
                document.getElementById('progress-area').style.display = 'block';
            }
        } else {
            // ArrayBufferå—ä¿¡
            incomingBuffer.push(data);
            receivedBytes += data.byteLength;
            updateProgress(receivedBytes, incomingInfo.size);

            if (receivedBytes >= incomingInfo.size) {
                log("å—ä¿¡å®Œäº†ã€‚çµåˆä¸­...");
                const blob = new Blob(incomingBuffer);
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = incomingInfo.name;
                link.textContent = `ğŸ’¾ ${incomingInfo.name} ã‚’ä¿å­˜`;
                link.style = "display:block; margin-top:10px; color:#00d2ff; font-weight:bold;";
                document.getElementById('download-area').appendChild(link);
            }
        }
    }

    function updateProgress(curr, total) {
        const pct = (curr / total) * 100;
        document.getElementById('progress-bar').style.width = pct + "%";
        document.getElementById('status-msg').textContent = `${Math.round(pct)}%`;
    }
</script>
</body>
</html>
