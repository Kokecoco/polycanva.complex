<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webå‹•ç”»ç·¨é›†ã‚¹ã‚¿ã‚¸ã‚ª Pro (å®Œå…¨ç‰ˆ)</title>
    
    <!-- 
      ã€é‡è¦ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™(SharedArrayBuffer)ã‚’å›é¿ã™ã‚‹ãŸã‚ã®ServiceWorkerèª­ã¿è¾¼ã¿ 
      å¿…ãšåŒã˜éšå±¤ã« coi-serviceworker.js ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚
    -->
    <script src="coi-serviceworker.js"></script>
    
    <!-- FFmpeg.wasmã®èª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆå®šç¾© */
        :root {
            --primary-color: #4f46e5;       /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼šç´«ç³» */
            --primary-hover: #4338ca;       /* ãƒ›ãƒãƒ¼æ™‚ */
            --background-color: #f3f4f6;    /* èƒŒæ™¯è‰² */
            --text-color: #1f2937;          /* æ–‡å­—è‰² */
            --panel-bg: #ffffff;            /* ãƒ‘ãƒãƒ«èƒŒæ™¯ */
            --border-color: #e5e7eb;        /* æ ç·š */
            
            --console-bg: #1e1e1e;          /* ã‚³ãƒ³ã‚½ãƒ¼ãƒ«èƒŒæ™¯ï¼ˆé»’ï¼‰ */
            --console-text: #d4d4d4;        /* ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ–‡å­—ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ */
        }

        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            background: var(--panel-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: normal;
            margin-left: 10px;
        }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå·¦å³2åˆ†å‰²ï¼‰ */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 1:1ã®æ¯”ç‡ */
            gap: 30px;
            margin-top: 20px;
        }
        
        /* ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 800px) {
            .grid-layout {
                grid-template-columns: 1fr; /* ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
            }
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }
        .drop-zone:hover {
            border-color: var(--primary-color);
            background-color: #eef2ff;
            transform: translateY(-2px);
        }
        .drop-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ç”» */
        video {
            width: 100%;
            border-radius: 8px;
            background: #000;
            display: none; /* ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã¾ã§éè¡¨ç¤º */
            max-height: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º */
        .file-info {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 10px;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 6px;
            display: none;
        }

        /* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .tabs-header {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-size: 0.95rem;
        }
        .tab-button:hover {
            color: #374151;
            background-color: #f9fafb;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* è¨­å®šãƒ‘ãƒãƒ«ã‚°ãƒ«ãƒ¼ãƒ— */
        .settings-panel {
            display: none;
            padding: 10px 5px;
            animation: fadeIn 0.3s ease;
        }
        .settings-panel.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 6px;
            color: #374151;
        }
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border 0.2s;
        }
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .input-row {
            display: flex;
            gap: 15px;
        }
        .input-row > div {
            flex: 1;
        }
        
        .description-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* é€²æ—ãƒãƒ¼ */
        .progress-area {
            margin-top: 25px;
            display: none;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        progress {
            width: 100%;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
        }
        .progress-label {
            text-align: center;
            font-size: 0.95rem;
            margin-top: 8px;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
        .download-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #10b981; /* ç·‘è‰² */
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            display: none;
            transition: background 0.2s;
        }
        .download-link:hover {
            background-color: #059669;
        }

        /* ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« */
        .console-wrapper {
            margin-top: 40px;
            border-top: 2px solid var(--border-color);
            padding-top: 20px;
        }
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .console-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .console-clear {
            font-size: 0.8rem;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }
        #console-log {
            background-color: var(--console-bg);
            color: var(--console-text);
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            font-size: 12px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.5;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        
        /* ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®è‰²åˆ†ã‘ */
        .log-info { color: #60a5fa; }    /* æƒ…å ±: é’ */
        .log-success { color: #4ade80; } /* æˆåŠŸ: ç·‘ */
        .log-warn { color: #fbbf24; }    /* è­¦å‘Š: é»„ */
        .log-error { color: #f87171; font-weight: bold; } /* ã‚¨ãƒ©ãƒ¼: èµ¤ */
        .log-system { color: #9ca3af; }  /* ã‚·ã‚¹ãƒ†ãƒ : ã‚°ãƒ¬ãƒ¼ */

    </style>
</head>
<body>

    <div class="container">
        <h1>Webå‹•ç”»ç·¨é›†ã‚¹ã‚¿ã‚¸ã‚ª <span class="subtitle">Professional</span></h1>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
        <div class="drop-zone" id="drop-zone">
            <span class="drop-icon">ğŸ“‚</span>
            <p style="font-size:1.2rem; font-weight:bold;">ã“ã“ã«å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p style="color:#64748b;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <input type="file" id="file-input" accept="video/*" style="display: none;">
        </div>

        <div class="grid-layout">
            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æƒ…å ± -->
            <div class="left-column">
                <video id="preview" controls playsinline></video>
                <div id="file-info" class="file-info"></div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šæ“ä½œãƒ‘ãƒãƒ« -->
            <div class="right-column">
                <!-- ã‚¿ãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="tabs-header">
                    <button class="tab-button active" data-target="panel-trim">æ™‚é–“ã‚«ãƒƒãƒˆ</button>
                    <button class="tab-button" data-target="panel-crop">ç”»é¢åˆ‡æŠœ</button>
                    <button class="tab-button" data-target="panel-speed">é€Ÿåº¦å¤‰æ›´</button>
                    <button class="tab-button" data-target="panel-convert">å¤‰æ›ãƒ»ä»–</button>
                </div>

                <!-- 1. æ™‚é–“ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ‘ãƒãƒ« -->
                <div id="panel-trim" class="settings-panel active">
                    <p class="description-text">å‹•ç”»ã®é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‚’æŒ‡å®šã—ã¦ã€å¿…è¦ãªéƒ¨åˆ†ã ã‘ã‚’åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚</p>
                    <div class="input-row">
                        <div class="form-group">
                            <label>é–‹å§‹ä½ç½® (ç§’)</label>
                            <input type="number" id="trim-start" value="0" step="0.1" min="0">
                        </div>
                        <div class="form-group">
                            <label>çµ‚äº†ä½ç½® (ç§’)</label>
                            <input type="number" id="trim-end" value="10" step="0.1" min="0">
                        </div>
                    </div>
                </div>

                <!-- 2. ç”»é¢ã‚¯ãƒ­ãƒƒãƒ—ãƒ‘ãƒãƒ« -->
                <div id="panel-crop" class="settings-panel">
                    <p class="description-text">ç”»é¢ã®ä½™åˆ†ãªéƒ¨åˆ†ã‚’åˆ‡ã‚Šå–ã‚Šã¾ã™ã€‚</p>
                    
                    <div class="form-group">
                        <label>ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ</label>
                        <select id="crop-preset">
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ  (æ•°å€¤ã‚’æ‰‹å…¥åŠ›)</option>
                            <option value="center-square">ä¸­å¤®ã‚’æ­£æ–¹å½¢ã« (1:1)</option>
                            <option value="center-43">ä¸­å¤®ã‚’4:3ã«</option>
                            <option value="center-169">ä¸­å¤®ã‚’16:9ã«</option>
                        </select>
                    </div>
                    
                    <div class="input-row">
                        <div class="form-group">
                            <label>å¹… (Width)</label>
                            <input type="number" id="crop-w" value="0">
                        </div>
                        <div class="form-group">
                            <label>é«˜ã• (Height)</label>
                            <input type="number" id="crop-h" value="0">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="form-group">
                            <label>Xåº§æ¨™ (å·¦ç«¯)</label>
                            <input type="number" id="crop-x" value="0">
                        </div>
                        <div class="form-group">
                            <label>Yåº§æ¨™ (ä¸Šç«¯)</label>
                            <input type="number" id="crop-y" value="0">
                        </div>
                    </div>
                </div>

                <!-- 3. é€Ÿåº¦å¤‰æ›´ãƒ‘ãƒãƒ« (å¾©åˆ»ç‰ˆ) -->
                <div id="panel-speed" class="settings-panel">
                    <p class="description-text">å‹•ç”»ã®å†ç”Ÿé€Ÿåº¦ã‚’å¤‰æ›´ã—ã¾ã™ã€‚æ˜ åƒã¨éŸ³å£°ã®ä¸¡æ–¹ã‚’èª¿æ•´ã—ã¾ã™ã€‚</p>
                    <div class="form-group">
                        <label>å†ç”Ÿã‚¹ãƒ”ãƒ¼ãƒ‰</label>
                        <select id="speed-value">
                            <option value="0.5">0.5å€ (ã‚¹ãƒ­ãƒ¼å†ç”Ÿ)</option>
                            <option value="1.25">1.25å€</option>
                            <option value="1.5">1.5å€</option>
                            <option value="2.0">2.0å€ (å€é€Ÿ)</option>
                        </select>
                    </div>
                </div>

                <!-- 4. å¤‰æ›ãƒ»ãã®ä»–ãƒ‘ãƒãƒ« -->
                <div id="panel-convert" class="settings-panel">
                    <p class="description-text">ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®å¤‰æ›ã‚„ã€ç‰¹åˆ¥ãªå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚</p>
                    <div class="form-group">
                        <label>ãƒ¢ãƒ¼ãƒ‰é¸æŠ</label>
                        <select id="convert-mode">
                            <option value="gif">GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ (5fps/480px)</option>
                            <option value="mp3">éŸ³å£°ã®ã¿æŠ½å‡º (.mp3)</option>
                            <option value="compress">è»½é‡åŒ–ãƒªã‚µã‚¤ã‚º (720p)</option>
                            <option value="mute">éŸ³å£°ã‚’å‰Šé™¤ (ãƒŸãƒ¥ãƒ¼ãƒˆ)</option>
                        </select>
                    </div>
                    <p style="font-size:0.8rem; color:#ef4444; margin-top:10px;">
                        â€»GIFå¤‰æ›ã¯éå¸¸ã«é‡ã„å‡¦ç†ã§ã™ã€‚10ç§’ä»¥å†…ã®å‹•ç”»ã§ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
                    </p>
                </div>

                <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
                <button id="run-btn" class="btn-primary" disabled>
                    å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
                </button>
                
                <!-- é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="progress-area" id="progress-wrap">
                    <progress id="progress-bar" value="0" max="100"></progress>
                    <div class="progress-label" id="progress-text">æº–å‚™ä¸­...</div>
                </div>

                <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ -->
                <a id="download-link" class="download-link">å®Œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</a>
            </div>
        </div>

        <!-- ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
        <div class="console-wrapper">
            <div class="console-header">
                <div class="console-title">ğŸ–¥ï¸ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚° / ã‚¨ãƒ©ãƒ¼å‡ºåŠ›</div>
                <div class="console-clear" onclick="clearLog()">ãƒ­ã‚°ã‚’æ¶ˆå»</div>
            </div>
            <div id="console-log"></div>
        </div>
    </div>

    <script>
        /* =========================================
           1. ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£… (DevToolsä»£æ›¿)
           ========================================= */
        const consoleLogDiv = document.getElementById('console-log');

        function getTimestamp() {
            const now = new Date();
            return now.toTimeString().split(' ')[0]; // "HH:MM:SS"
        }

        function logToPage(message, type = 'system') {
            const line = document.createElement('div');
            line.className = `log-${type}`;
            line.textContent = `[${getTimestamp()}] ${message}`;
            consoleLogDiv.appendChild(line);
            // å¸¸ã«ä¸€ç•ªä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            consoleLogDiv.scrollTop = consoleLogDiv.scrollHeight;
        }

        function clearLog() {
            consoleLogDiv.innerHTML = '';
            logToPage('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', 'system');
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã® console.log / console.error ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ç”»é¢ã«è¡¨ç¤º
        const originalLog = console.log;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            const msg = args.map(arg => (typeof arg === 'object' ? JSON.stringify(arg) : arg)).join(' ');
            logToPage(msg, 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            const msg = args.map(arg => (typeof arg === 'object' ? (arg.message || JSON.stringify(arg)) : arg)).join(' ');
            logToPage(msg, 'error');
        };

        logToPage('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'system');


        /* =========================================
           2. FFmpeg.wasm ã®åˆæœŸåŒ–å‡¦ç†
           ========================================= */
        const { createFFmpeg, fetchFile } = FFmpeg;
        let ffmpeg = null;
        let videoFile = null;
        let videoDuration = 0;

        const initFFmpeg = async () => {
            try {
                logToPage('ç’°å¢ƒãƒã‚§ãƒƒã‚¯ä¸­...', 'system');
                
                // SharedArrayBuffer ã®ãƒã‚§ãƒƒã‚¯ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã®ç¢ºèª)
                if (typeof SharedArrayBuffer === 'undefined') {
                    logToPage('ã€è­¦å‘Šã€‘SharedArrayBuffer ãŒç„¡åŠ¹ã§ã™ã€‚coi-serviceworker.js ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹ã€HTTPS/ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ä»¥å¤–ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚å‡¦ç†ãŒå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'warn');
                } else {
                    logToPage('SharedArrayBuffer ã¯æœ‰åŠ¹ã§ã™ã€‚', 'success');
                }

                logToPage('FFmpegã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹...', 'info');

                ffmpeg = createFFmpeg({
                    corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
                    log: true, // å†…éƒ¨ãƒ­ã‚°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºã™
                    logger: ({ type, message }) => {
                        // å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
                        if (type === 'fferr') {
                            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã‚‰é€²æ—ç‡ã‚’è¨ˆç®— (ä¾‹: time=00:00:05.20)
                            const match = message.match(/time=([0-9:.]+)/);
                            if (match && videoDuration > 0) {
                                const t = match[1].split(':');
                                const currentTime = parseFloat(t[0]) * 3600 + parseFloat(t[1]) * 60 + parseFloat(t[2]);
                                const percent = Math.min((currentTime / videoDuration) * 100, 100);
                                updateProgress(percent);
                            }
                        }
                    }
                });

                await ffmpeg.load();
                logToPage('âœ… FFmpegã‚¨ãƒ³ã‚¸ãƒ³ã®èµ·å‹•ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');

            } catch (error) {
                console.error('FFmpegèµ·å‹•ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                logToPage('ã€è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã€‘FFmpegã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GitHub Pagesã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€coi-serviceworker.js ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', initFFmpeg);


        /* =========================================
           3. UIæ“ä½œã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
           ========================================= */
        const els = {
            drop: document.getElementById('drop-zone'),
            input: document.getElementById('file-input'),
            video: document.getElementById('preview'),
            fileInfo: document.getElementById('file-info'),
            tabs: document.querySelectorAll('.tab-button'),
            panels: document.querySelectorAll('.settings-panel'),
            btn: document.getElementById('run-btn'),
            dlLink: document.getElementById('download-link'),
            progressWrap: document.getElementById('progress-wrap'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            
            // Inputs
            trimStart: document.getElementById('trim-start'),
            trimEnd: document.getElementById('trim-end'),
            
            cropPreset: document.getElementById('crop-preset'),
            cropW: document.getElementById('crop-w'),
            cropH: document.getElementById('crop-h'),
            cropX: document.getElementById('crop-x'),
            cropY: document.getElementById('crop-y'),
            
            speedValue: document.getElementById('speed-value'),
            convertMode: document.getElementById('convert-mode')
        };

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        const handleFile = (file) => {
            if (!file) return;
            logToPage(`ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼é–‹å§‹: ${file.name} (ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');
            
            videoFile = file;
            const url = URL.createObjectURL(file);
            els.video.src = url;
            els.video.style.display = 'block';
            els.fileInfo.style.display = 'block';
            els.drop.style.display = 'none';
            els.dlLink.style.display = 'none';
            els.btn.disabled = false;
            els.btn.textContent = 'å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹';

            // å‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†æ™‚
            els.video.onloadedmetadata = () => {
                videoDuration = els.video.duration;
                
                // çµ‚äº†æ™‚é–“ã®åˆæœŸå€¤ã‚’å‹•ç”»ã®é•·ã•ã«è¨­å®š
                els.trimEnd.value = videoDuration.toFixed(1);
                
                // ã‚¯ãƒ­ãƒƒãƒ—å…¥åŠ›ã®åˆæœŸå€¤ã‚’å‹•ç”»ã‚µã‚¤ã‚ºã«è¨­å®š
                els.cropW.value = els.video.videoWidth;
                els.cropH.value = els.video.videoHeight;
                els.cropX.value = 0;
                els.cropY.value = 0;

                els.fileInfo.innerHTML = `
                    <strong>èª­ã¿è¾¼ã¿æˆåŠŸ</strong><br>
                    è§£åƒåº¦: ${els.video.videoWidth} x ${els.video.videoHeight}<br>
                    é•·ã•: ${videoDuration.toFixed(2)} ç§’
                `;
                logToPage(`ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${els.video.videoWidth}x${els.video.videoHeight}, ${videoDuration.toFixed(2)}s`, 'success');
            };

            els.video.onerror = () => {
                logToPage('å‹•ç”»ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¯¾å¿œã—ã¦ã„ãªã„å½¢å¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
            };
        };

        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
        els.drop.addEventListener('click', () => els.input.click());
        els.input.addEventListener('change', (e) => handleFile(e.target.files[0]));
        els.drop.addEventListener('dragover', (e) => e.preventDefault());
        els.drop.addEventListener('drop', (e) => {
            e.preventDefault();
            handleFile(e.dataTransfer.files[0]);
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
        els.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã®ä»˜ã‘æ›¿ãˆ
                els.tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                const targetId = tab.dataset.target;
                els.panels.forEach(panel => panel.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                
                logToPage(`ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´: ${tab.textContent}`, 'system');
            });
        });

        // ã‚¯ãƒ­ãƒƒãƒ—ãƒ—ãƒªã‚»ãƒƒãƒˆã®é€£å‹•
        els.cropPreset.addEventListener('change', (e) => {
            const w = els.video.videoWidth;
            const h = els.video.videoHeight;
            if (!w || !h) return;

            let newW = w, newH = h, newX = 0, newY = 0;
            const val = e.target.value;

            if (val === 'center-square') {
                const size = Math.min(w, h);
                newW = size; newH = size;
                newX = (w - size) / 2;
                newY = (h - size) / 2;
            } else if (val === 'center-43') {
                if (w / h > 4 / 3) {
                    newH = h; newW = h * 4 / 3;
                } else {
                    newW = w; newH = w * 3 / 4;
                }
                newX = (w - newW) / 2;
                newY = (h - newH) / 2;
            } else if (val === 'center-169') {
                if (w / h > 16 / 9) {
                    newH = h; newW = h * 16 / 9;
                } else {
                    newW = w; newH = w * 9 / 16;
                }
                newX = (w - newW) / 2;
                newY = (h - newH) / 2;
            }
            
            if (val !== 'custom') {
                els.cropW.value = Math.round(newW);
                els.cropH.value = Math.round(newH);
                els.cropX.value = Math.round(newX);
                els.cropY.value = Math.round(newY);
                logToPage(`ã‚¯ãƒ­ãƒƒãƒ—ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨: ${val}`, 'info');
            }
        });


        /* =========================================
           4. å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ (FFmpegã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ)
           ========================================= */
        const updateProgress = (percent) => {
            els.progressBar.value = percent;
            els.progressText.textContent = `å‡¦ç†ä¸­... ${Math.round(percent)}%`;
        };

        els.btn.addEventListener('click', async () => {
            // å®‰å…¨ãƒã‚§ãƒƒã‚¯
            if (!ffmpeg || !ffmpeg.isLoaded()) {
                logToPage('ã‚¨ãƒ³ã‚¸ãƒ³ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚å°‘ã€…ãŠå¾…ã¡ä¸‹ã•ã„ã€‚', 'warn');
                return;
            }
            if (!videoFile) {
                logToPage('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warn');
                return;
            }

            // UIãƒ­ãƒƒã‚¯
            els.btn.disabled = true;
            els.progressWrap.style.display = 'block';
            els.dlLink.style.display = 'none';
            updateProgress(0);
            logToPage('=== å‡¦ç†ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹ ===', 'info');

            // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’ç¢ºèª
            const activePanelId = document.querySelector('.settings-panel.active').id;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åè¨­å®š
            const inFileName = 'input_video'; 
            let outFileName = 'output.mp4';
            let mimeType = 'video/mp4';
            let args = [];

            try {
                // 1. ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸æ›¸ãè¾¼ã¿
                logToPage('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«æ›¸ãè¾¼ã¿ä¸­...', 'system');
                ffmpeg.FS('writeFile', inFileName, await fetchFile(videoFile));

                // 2. å„ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ
                if (activePanelId === 'panel-trim') {
                    /* --- ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ --- */
                    const start = els.trimStart.value;
                    const end = els.trimEnd.value;
                    const duration = end - start;
                    
                    if (duration <= 0) throw new Error('çµ‚äº†æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã‚ã«è¨­å®šã—ã¦ãã ã•ã„');
                    
                    logToPage(`ãƒˆãƒªãƒŸãƒ³ã‚°å®Ÿè¡Œ: ${start}s ~ ${end}s (é•·ã•:${duration}s)`, 'info');
                    
                    args = [
                        '-ss', start,
                        '-i', inFileName,
                        '-t', String(duration),
                        '-c:v', 'libx264',
                        '-preset', 'ultrafast',
                        '-c:a', 'aac',
                        outFileName
                    ];

                } else if (activePanelId === 'panel-crop') {
                    /* --- ã‚¯ãƒ­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ --- */
                    const w = els.cropW.value;
                    const h = els.cropH.value;
                    const x = els.cropX.value;
                    const y = els.cropY.value;

                    logToPage(`ã‚¯ãƒ­ãƒƒãƒ—å®Ÿè¡Œ: ${w}x${h} (X:${x}, Y:${y})`, 'info');
                    
                    args = [
                        '-i', inFileName,
                        '-vf', `crop=${w}:${h}:${x}:${y}`,
                        '-c:v', 'libx264',
                        '-preset', 'ultrafast',
                        '-c:a', 'copy', // éŸ³å£°ã¯ã‚³ãƒ”ãƒ¼ã§é«˜é€ŸåŒ–
                        outFileName
                    ];

                } else if (activePanelId === 'panel-speed') {
                    /* --- é€Ÿåº¦å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰ (å¾©åˆ») --- */
                    const speed = parseFloat(els.speedValue.value);
                    logToPage(`é€Ÿåº¦å¤‰æ›´å®Ÿè¡Œ: ${speed}å€é€Ÿ`, 'info');
                    
                    // æ˜ åƒ(setpts)ã¨éŸ³å£°(atempo)ã®ä¸¡æ–¹ã‚’å¤‰æ›´
                    // setpts = 1/speed * PTS
                    // atempo = speed
                    args = [
                        '-i', inFileName,
                        '-filter_complex', `[0:v]setpts=${1/speed}*PTS[v];[0:a]atempo=${speed}[a]`,
                        '-map', '[v]',
                        '-map', '[a]',
                        '-c:v', 'libx264',
                        '-preset', 'ultrafast',
                        outFileName
                    ];

                } else if (activePanelId === 'panel-convert') {
                    /* --- å¤‰æ›ãƒ»ãã®ä»–ãƒ¢ãƒ¼ãƒ‰ --- */
                    const mode = els.convertMode.value;
                    logToPage(`å¤‰æ›ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ: ${mode}`, 'info');

                    if (mode === 'gif') {
                        outFileName = 'output.gif';
                        mimeType = 'image/gif';
                        // é«˜ç”»è³ªãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆã‚’å«ã‚€GIFå¤‰æ›
                        args = [
                            '-i', inFileName,
                            '-vf', 'fps=5,scale=480:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse',
                            outFileName
                        ];
                    } else if (mode === 'mp3') {
                        outFileName = 'output.mp3';
                        mimeType = 'audio/mpeg';
                        args = [
                            '-i', inFileName,
                            '-q:a', '0',
                            '-map', 'a',
                            outFileName
                        ];
                    } else if (mode === 'compress') {
                        // 720pãƒªã‚µã‚¤ã‚º + CRF28ã§åœ§ç¸®
                        args = [
                            '-i', inFileName,
                            '-vf', 'scale=-1:720',
                            '-c:v', 'libx264',
                            '-crf', '28',
                            '-preset', 'ultrafast',
                            outFileName
                        ];
                    } else if (mode === 'mute') {
                        // éŸ³å£°å‰Šé™¤ (-an)
                        args = [
                            '-i', inFileName,
                            '-an',
                            '-c:v', 'copy',
                            outFileName
                        ];
                    }
                }

                // 3. ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
                logToPage(`ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ: ffmpeg ${args.join(' ')}`, 'system');
                await ffmpeg.run(...args);

                logToPage('FFmpegå‡¦ç†å®Œäº†ã€‚å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...', 'success');

                // 4. çµæœãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¨BlobåŒ–
                const data = ffmpeg.FS('readFile', outFileName);
                const blob = new Blob([data.buffer], { type: mimeType });
                const url = URL.createObjectURL(blob);

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯è¨­å®š
                els.dlLink.href = url;
                // ãƒ•ã‚¡ã‚¤ãƒ«åã«ç¾åœ¨æ™‚åˆ»ã‚’å…¥ã‚Œã‚‹
                const timestamp = new Date().getTime();
                const ext = outFileName.split('.').pop();
                els.dlLink.download = `edited_${timestamp}.${ext}`;
                
                els.dlLink.style.display = 'block';
                els.dlLink.textContent = 'å®Œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹';
                
                updateProgress(100);
                els.progressText.textContent = 'ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                logToPage('å‡¦ç†æˆåŠŸï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚', 'success');

            } catch (error) {
                console.error(error);
                logToPage(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                els.progressText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            } finally {
                els.btn.disabled = false;
                // ãƒ¡ãƒ¢ãƒªæƒé™¤ (try-catchã§å›²ã‚€)
                try {
                    // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
                    if (ffmpeg.FS('readdir', '/').includes(inFileName)) {
                        ffmpeg.FS('unlink', inFileName);
                    }
                    // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
                    if (ffmpeg.FS('readdir', '/').includes(outFileName)) {
                        ffmpeg.FS('unlink', outFileName);
                    }
                } catch(cleanupError) {
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ã‚ˆã„
                }
            }
        });

    </script>
</body>
</html>
