<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web動画編集スタジオ WYSIWYG</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #121212; --panel-bg: #1e1e1e; --sidebar-bg: #252525;
            --accent: #00e5ff; /* シアン系に変更 */
            --accent-hover: #00b8d4;
            --text: #e0e0e0; --border: #444;
        }
        body { margin:0; font-family: sans-serif; background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* レイアウト */
        header { background: var(--panel-bg); padding: 0 20px; height: 50px; display: flex; align-items: center; border-bottom: 1px solid var(--border); justify-content: space-between; }
        h1 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; margin: 0; color: var(--accent); }
        .main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 60px; background: var(--sidebar-bg); display: flex; flex-direction: column; align-items: center; padding-top: 10px; border-right: 1px solid var(--border); }
        .tool-btn { width: 40px; height: 40px; border: none; background: none; color: #888; cursor: pointer; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tool-btn.active { background: var(--accent); color: #000; }
        
        .workspace { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; min-width: 0; }
        
        /* プレビューエリア (Crop UI含む) */
        .preview-container { 
            flex: 1; background: #000; border: 1px solid var(--border); border-radius: 8px; 
            position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden;
            user-select: none;
        }
        /* 動画とオーバーレイのラッパー */
        .video-wrapper { position: relative; display: inline-block; line-height: 0; }
        video { max-width: 100%; max-height: 60vh; pointer-events: none; display: block; }
        
        /* クロップオーバーレイ */
        #crop-overlay {
            position: absolute; top: 0; left: 0; border: 2px solid var(--accent);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* 周りを暗くする */
            cursor: move; display: none; box-sizing: border-box;
        }
        /* リサイズハンドル */
        .resize-handle {
            width: 12px; height: 12px; background: var(--accent); position: absolute;
            bottom: -6px; right: -6px; cursor: nwse-resize; border-radius: 50%;
        }
        .crop-dim-text {
            position: absolute; top: -25px; left: 0; background: var(--accent); color: black;
            font-size: 10px; padding: 2px 5px; border-radius: 2px; pointer-events: none; font-weight: bold;
        }

        /* タイムラインエリア */
        .timeline-area { height: 80px; background: var(--panel-bg); border-radius: 8px; padding: 10px 20px; display: flex; flex-direction: column; justify-content: center; border: 1px solid var(--border); }
        .timeline-track { position: relative; height: 8px; background: #444; border-radius: 4px; margin-top: 15px; cursor: pointer; }
        .timeline-fill { position: absolute; height: 100%; background: var(--accent); opacity: 0.5; top: 0; }
        .timeline-handle { 
            position: absolute; top: -8px; width: 4px; height: 24px; background: #fff; 
            cursor: ew-resize; border-radius: 2px; z-index: 2; 
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .timeline-handle::after { content:''; position:absolute; top:-15px; left:-10px; width:24px; height:15px; /* hit area */ }
        #handle-start { background: #81c784; }
        #handle-end { background: #e57373; }
        .time-labels { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 5px; }

        /* 右パネル */
        .properties-panel { width: 280px; background: var(--panel-bg); border-left: 1px solid var(--border); padding: 20px; overflow-y: auto; }
        .panel-section { display: none; }
        .panel-section.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from{opacity:0; transform:translateY(5px);} to{opacity:1;} }

        h3 { margin: 0 0 15px 0; font-size: 1rem; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        input, select { width: 100%; background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: var(--accent); color: #000; margin-top: 20px; }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* Console */
        .console-drawer { height: 120px; background: #000; border-top: 1px solid var(--border); padding: 10px; font-family: monospace; font-size: 11px; color: #888; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>

    <header>
        <h1><span class="material-icons-round">video_settings</span> Studio WYSIWYG</h1>
        <button onclick="location.reload()" style="background:none; border:1px solid #444; color:#fff; padding:5px 10px; cursor:pointer;">Reset</button>
    </header>

    <div class="main">
        <!-- 左ツールバー -->
        <div class="sidebar">
            <button class="tool-btn active" data-target="p-trim" title="トリミング"><span class="material-icons-round">content_cut</span></button>
            <button class="tool-btn" data-target="p-crop" title="クロップ"><span class="material-icons-round">crop</span></button>
            <button class="tool-btn" data-target="p-convert" title="変換"><span class="material-icons-round">transform</span></button>
        </div>

        <!-- メインエリア -->
        <div class="workspace">
            <!-- プレビュー画面 -->
            <div class="preview-container" id="drop-zone">
                <div id="upload-msg" style="color:#666; text-align:center;">
                    <span class="material-icons-round" style="font-size:48px">cloud_upload</span><br>ドラッグ＆ドロップ
                </div>
                
                <!-- ビデオとクロップ枠のラッパー -->
                <div class="video-wrapper" id="video-wrapper" style="display:none;">
                    <video id="preview" playsinline></video>
                    
                    <!-- クロップ用オーバーレイ -->
                    <div id="crop-overlay">
                        <div class="crop-dim-text" id="crop-dim-text">0x0</div>
                        <div class="resize-handle" id="resize-handle"></div>
                    </div>
                </div>
                <input type="file" id="file-input" hidden accept="video/*">
            </div>

            <!-- タイムライン -->
            <div class="timeline-area">
                <div class="time-labels">
                    <span id="lbl-start">0.0s</span>
                    <span id="lbl-current" style="color:var(--accent);">0.0s</span>
                    <span id="lbl-end">0.0s</span>
                </div>
                <div class="timeline-track" id="timeline-track">
                    <div class="timeline-fill" id="timeline-fill"></div>
                    <div class="timeline-handle" id="handle-start" style="left:0%"></div>
                    <div class="timeline-handle" id="handle-end" style="left:100%"></div>
                </div>
            </div>
        </div>

        <!-- 右プロパティパネル -->
        <div class="properties-panel">
            <!-- トリミング設定 -->
            <div id="p-trim" class="panel-section active">
                <h3>カット編集</h3>
                <div class="form-group"><label>開始時間 (秒)</label><input type="number" id="val-trim-start" value="0" step="0.1"></div>
                <div class="form-group"><label>終了時間 (秒)</label><input type="number" id="val-trim-end" value="0" step="0.1"></div>
                <p style="font-size:11px; color:#888;">下のタイムラインバーを操作しても変更できます。</p>
            </div>

            <!-- クロップ設定 -->
            <div id="p-crop" class="panel-section">
                <h3>画面切り抜き</h3>
                <div class="form-group">
                    <label>プリセット</label>
                    <select id="crop-preset">
                        <option value="custom">カスタム (マウス操作)</option>
                        <option value="1:1">正方形 (1:1)</option>
                        <option value="16:9">ワイド (16:9)</option>
                    </select>
                </div>
                <div style="display:flex; gap:5px;">
                    <div class="form-group"><label>幅</label><input type="number" id="val-crop-w" readonly></div>
                    <div class="form-group"><label>高さ</label><input type="number" id="val-crop-h" readonly></div>
                </div>
                <div style="display:flex; gap:5px;">
                    <div class="form-group"><label>X</label><input type="number" id="val-crop-x" readonly></div>
                    <div class="form-group"><label>Y</label><input type="number" id="val-crop-y" readonly></div>
                </div>
                <p style="font-size:11px; color:#888;">プレビュー上の青い枠を操作してください。</p>
            </div>

            <!-- 変換設定 -->
            <div id="p-convert" class="panel-section">
                <h3>出力・変換</h3>
                <div class="form-group">
                    <label>モード</label>
                    <select id="convert-mode">
                        <option value="mp4">通常出力 (MP4)</option>
                        <option value="gif">GIFアニメ (5fps)</option>
                        <option value="mp3">音声のみ (MP3)</option>
                    </select>
                </div>
            </div>

            <button id="run-btn" class="btn" disabled>処理を実行</button>
            <div id="progress-text" style="text-align:center; margin-top:10px; font-size:12px; color:#aaa;"></div>
            <a id="dl-link" class="btn" style="background:#00c853; color:white; text-decoration:none; display:none; text-align:center;">ダウンロード</a>
        </div>
    </div>
    
    <div class="console-drawer" id="console-log">System Ready.</div>

    <script>
        const log = (msg) => {
            const d = document.getElementById('console-log');
            d.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            d.scrollTop = d.scrollHeight;
        }
        const { createFFmpeg, fetchFile } = FFmpeg;
        let ffmpeg = null;
        let videoFile = null;
        let meta = { dur: 0, w: 0, h: 0 };
        let activeTab = 'p-trim';

        // UI Elements
        const els = {
            video: document.getElementById('preview'),
            videoWrapper: document.getElementById('video-wrapper'),
            cropOverlay: document.getElementById('crop-overlay'),
            resizeHandle: document.getElementById('resize-handle'),
            cropDimText: document.getElementById('crop-dim-text'),
            
            // Timeline
            track: document.getElementById('timeline-track'),
            fill: document.getElementById('timeline-fill'),
            hStart: document.getElementById('handle-start'),
            hEnd: document.getElementById('handle-end'),
            
            // Inputs
            inTrimStart: document.getElementById('val-trim-start'),
            inTrimEnd: document.getElementById('val-trim-end'),
            inCropW: document.getElementById('val-crop-w'),
            inCropH: document.getElementById('val-crop-h'),
            inCropX: document.getElementById('val-crop-x'),
            inCropY: document.getElementById('val-crop-y'),
        };

        /* ================= 1. 初期化 & ファイル読込 ================= */
        window.addEventListener('load', async () => {
            if(typeof SharedArrayBuffer === 'undefined') log("WARN: SharedArrayBuffer missing. Check coi-serviceworker.js");
            ffmpeg = createFFmpeg({ corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js', log: false });
            ffmpeg.setLogger(({ type, message }) => {
                if(type==='fferr' && message.includes('time=')) {
                    const m = message.match(/time=([0-9:.]+)/);
                    if(m) document.getElementById('progress-text').textContent = `Processing: ${m[1]}`;
                }
            });
            await ffmpeg.load();
            log("FFmpeg Loaded.");
        });

        const loadFile = (file) => {
            if(!file) return;
            videoFile = file;
            els.video.src = URL.createObjectURL(file);
            document.getElementById('upload-msg').style.display = 'none';
            els.videoWrapper.style.display = 'inline-block';
            document.getElementById('run-btn').disabled = false;
            
            els.video.onloadedmetadata = () => {
                meta = { dur: els.video.duration, w: els.video.videoWidth, h: els.video.videoHeight };
                // Init Trim
                els.inTrimEnd.value = meta.dur.toFixed(1);
                updateTimelineUI();
                
                // Init Crop (Reset to full)
                cropState = { x:0, y:0, w:meta.w, h:meta.h };
                updateCropOverlay();
                
                log(`Loaded: ${meta.w}x${meta.h}, ${meta.dur.toFixed(1)}s`);
            };
        };

        document.getElementById('drop-zone').addEventListener('click', e => {
            if(e.target.id !== 'resize-handle' && e.target.id !== 'crop-overlay') document.getElementById('file-input').click();
        });
        document.getElementById('file-input').addEventListener('change', e => loadFile(e.target.files[0]));
        document.getElementById('drop-zone').addEventListener('dragover', e=>e.preventDefault());
        document.getElementById('drop-zone').addEventListener('drop', e=>{e.preventDefault(); loadFile(e.dataTransfer.files[0])});

        /* ================= 2. タブ切り替え ================= */
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
                document.querySelectorAll('.panel-section').forEach(p=>p.classList.remove('active'));
                btn.classList.add('active');
                activeTab = btn.dataset.target;
                document.getElementById(activeTab).classList.add('active');
                
                // Show/Hide Crop Overlay
                els.cropOverlay.style.display = (activeTab === 'p-crop') ? 'block' : 'none';
            });
        });

        /* ================= 3. タイムラインロジック ================= */
        let isDraggingTimeline = false;
        let activeHandle = null;

        const updateTimelineUI = () => {
            const start = parseFloat(els.inTrimStart.value);
            const end = parseFloat(els.inTrimEnd.value);
            const pctStart = (start / meta.dur) * 100;
            const pctEnd = (end / meta.dur) * 100;
            
            els.hStart.style.left = `${pctStart}%`;
            els.hEnd.style.left = `${pctEnd}%`;
            els.fill.style.left = `${pctStart}%`;
            els.fill.style.width = `${pctEnd - pctStart}%`;
            
            document.getElementById('lbl-start').textContent = start.toFixed(1) + 's';
            document.getElementById('lbl-end').textContent = end.toFixed(1) + 's';
        };

        const handleTimelineMove = (e) => {
            if(!isDraggingTimeline || !meta.dur) return;
            const rect = els.track.getBoundingClientRect();
            let pct = (e.clientX - rect.left) / rect.width;
            pct = Math.max(0, Math.min(1, pct));
            const time = pct * meta.dur;
            
            if(activeHandle === 'start') {
                const curEnd = parseFloat(els.inTrimEnd.value);
                if(time < curEnd) els.inTrimStart.value = time.toFixed(1);
                els.video.currentTime = time;
            } else {
                const curStart = parseFloat(els.inTrimStart.value);
                if(time > curStart) els.inTrimEnd.value = time.toFixed(1);
                els.video.currentTime = time;
            }
            updateTimelineUI();
        };

        els.hStart.addEventListener('mousedown', () => { isDraggingTimeline=true; activeHandle='start'; });
        els.hEnd.addEventListener('mousedown', () => { isDraggingTimeline=true; activeHandle='end'; });
        document.addEventListener('mousemove', handleTimelineMove);
        document.addEventListener('mouseup', () => isDraggingTimeline = false);
        
        // Manual Input Sync
        els.inTrimStart.addEventListener('change', updateTimelineUI);
        els.inTrimEnd.addEventListener('change', updateTimelineUI);


        /* ================= 4. クロップロジック (WYSIWYG) ================= */
        let cropState = { x:0, y:0, w:0, h:0 };
        let isDraggingCrop = false;
        let isResizingCrop = false;
        let dragStart = { x:0, y:0 };
        let initCropState = {};

        const getScale = () => els.video.clientWidth / meta.w;

        const updateCropOverlay = () => {
            const scale = getScale();
            if(!scale) return;
            
            // State to UI (px)
            els.cropOverlay.style.left = `${cropState.x * scale}px`;
            els.cropOverlay.style.top = `${cropState.y * scale}px`;
            els.cropOverlay.style.width = `${cropState.w * scale}px`;
            els.cropOverlay.style.height = `${cropState.h * scale}px`;
            
            els.cropDimText.textContent = `${Math.round(cropState.w)} x ${Math.round(cropState.h)}`;

            // Update Inputs
            els.inCropW.value = Math.round(cropState.w);
            els.inCropH.value = Math.round(cropState.h);
            els.inCropX.value = Math.round(cropState.x);
            els.inCropY.value = Math.round(cropState.y);
        };

        // Resize Handle (Bottom Right)
        els.resizeHandle.addEventListener('mousedown', (e) => {
            isResizingCrop = true;
            dragStart = { x: e.clientX, y: e.clientY };
            initCropState = { ...cropState };
            e.stopPropagation(); // Prevent drag
        });

        // Drag Box
        els.cropOverlay.addEventListener('mousedown', (e) => {
            isDraggingCrop = true;
            dragStart = { x: e.clientX, y: e.clientY };
            initCropState = { ...cropState };
        });

        document.addEventListener('mousemove', (e) => {
            const scale = getScale();
            if(!scale) return;

            if(isResizingCrop) {
                const dx = (e.clientX - dragStart.x) / scale;
                const dy = (e.clientY - dragStart.y) / scale;
                cropState.w = Math.max(10, Math.min(meta.w - initCropState.x, initCropState.w + dx));
                cropState.h = Math.max(10, Math.min(meta.h - initCropState.y, initCropState.h + dy));
                updateCropOverlay();
            } else if(isDraggingCrop) {
                const dx = (e.clientX - dragStart.x) / scale;
                const dy = (e.clientY - dragStart.y) / scale;
                cropState.x = Math.max(0, Math.min(meta.w - initCropState.w, initCropState.x + dx));
                cropState.y = Math.max(0, Math.min(meta.h - initCropState.h, initCropState.y + dy));
                updateCropOverlay();
            }
        });

        document.addEventListener('mouseup', () => { isDraggingCrop=false; isResizingCrop=false; });
        
        // Preset Handler
        document.getElementById('crop-preset').addEventListener('change', (e) => {
            const val = e.target.value;
            if(val === '1:1') {
                const s = Math.min(meta.w, meta.h);
                cropState = { w: s, h: s, x: (meta.w-s)/2, y: (meta.h-s)/2 };
            } else if(val === '16:9') {
                let w = meta.w, h = meta.w * 9/16;
                if(h > meta.h) { h = meta.h; w = h * 16/9; }
                cropState = { w: w, h: h, x: (meta.w-w)/2, y: (meta.h-h)/2 };
            }
            updateCropOverlay();
        });
        
        // Window Resize handling
        window.addEventListener('resize', updateCropOverlay);


        /* ================= 5. 実行ロジック ================= */
        document.getElementById('run-btn').addEventListener('click', async () => {
            if(!ffmpeg.isLoaded()) return;
            const btn = document.getElementById('run-btn');
            const dl = document.getElementById('dl-link');
            btn.disabled = true; dl.style.display='none';
            log("Processing Started...");

            const inName = 'input.mp4';
            const outName = 'output.mp4';
            let args = [];

            try {
                ffmpeg.FS('writeFile', inName, await fetchFile(videoFile));

                if(activeTab === 'p-trim') {
                    const dur = parseFloat(els.inTrimEnd.value) - parseFloat(els.inTrimStart.value);
                    args = ['-ss', els.inTrimStart.value, '-i', inName, '-t', dur.toString(), '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', outName];
                } else if(activeTab === 'p-crop') {
                    const { w, h, x, y } = cropState;
                    args = ['-i', inName, '-vf', `crop=${Math.round(w)}:${Math.round(h)}:${Math.round(x)}:${Math.round(y)}`, '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'copy', outName];
                } else {
                    const mode = document.getElementById('convert-mode').value;
                    if(mode==='gif') args = ['-i', inName, '-vf', 'fps=5,scale=480:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse', 'output.gif'];
                    else if(mode==='mp3') args = ['-i', inName, '-q:a', '0', '-map', 'a', 'output.mp3'];
                    else args = ['-i', inName, '-c:v', 'copy', '-c:a', 'copy', outName];
                }

                await ffmpeg.run(...args);
                
                const outFn = (args.includes('output.gif')) ? 'output.gif' : (args.includes('output.mp3') ? 'output.mp3' : 'output.mp4');
                const data = ffmpeg.FS('readFile', outFn);
                const blob = new Blob([data.buffer], { type: outFn.endsWith('gif')?'image/gif':(outFn.endsWith('mp3')?'audio/mpeg':'video/mp4') });
                
                dl.href = URL.createObjectURL(blob);
                dl.download = `wysiwyg_${Date.now()}_${outFn}`;
                dl.style.display = 'block';
                log("Completed!");

            } catch(e) {
                console.error(e);
                log("Error: " + e.message);
            } finally {
                btn.disabled = false;
                try { ffmpeg.FS('unlink', inName); ffmpeg.FS('unlink', outName); } catch(e){}
            }
        });
    </script>
</body>
</html>
