<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webå‹•ç”»ç·¨é›†ã‚¹ã‚¿ã‚¸ã‚ªï¼ˆãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä»˜ãï¼‰</title>
    <!-- FFmpeg.wasmã®èª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --text: #1f2937;
            --console-bg: #1e1e1e;
            --console-text: #d4d4d4;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg);
            color: var(--text);
        }
        
        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        h1 { text-align: center; margin-top: 0; color: var(--primary); }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: #fafafa;
        }
        .drop-zone:hover { border-color: var(--primary); background: #eef2ff; }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ç”» */
        video {
            width: 100%;
            border-radius: 6px;
            background: #000;
            display: none;
            max-height: 400px;
        }

        /* ã‚¿ãƒ– UI */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
        .tab {
            padding: 10px 15px; cursor: pointer; font-weight: bold; color: #6b7280;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: 0.2s;
        }
        .tab.active { color: var(--primary); border-color: var(--primary); }
        .tab:hover:not(.active) { color: #374151; background: #f9fafb; }

        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .settings-group { display: none; padding: 10px 0; }
        .settings-group.active { display: block; }
        
        label { display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; color: #374151; }
        input, select {
            width: 100%; padding: 10px; border: 1px solid #d1d5db;
            border-radius: 6px; box-sizing: border-box; margin-bottom: 15px;
        }
        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }

        /* ãƒœã‚¿ãƒ³ */
        .btn-primary {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 6px; font-size: 16px; cursor: pointer;
            transition: 0.2s; font-weight: bold; margin-top: 10px;
        }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.1); }

        /* é€²æ—ãƒãƒ¼ */
        .progress-container { margin-top: 20px; display: none; }
        progress { width: 100%; height: 20px; border-radius: 10px; }
        .progress-text { text-align: center; font-size: 0.9rem; margin-top: 5px; font-weight: bold; }

        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
        .download-btn {
            display: block; text-align: center; margin-top: 20px; padding: 14px;
            background: #10b981; color: white; text-decoration: none;
            border-radius: 6px; font-weight: bold; display: none;
        }

        /* ==============================
           ç”»é¢å†…ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (DevToolsä»£æ›¿)
           ============================== */
        .console-wrapper {
            margin-top: 30px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }
        .console-header {
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        .clear-log {
            cursor: pointer; color: var(--primary); text-decoration: underline;
        }
        #console-log {
            background-color: var(--console-bg);
            color: var(--console-text);
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            font-size: 12px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            border-radius: 6px;
            white-space: pre-wrap;
            line-height: 1.4;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        /* ãƒ­ã‚°ã®è‰²åˆ†ã‘ */
        .log-info { color: #60a5fa; } /* é’ç³» */
        .log-success { color: #4ade80; } /* ç·‘ç³» */
        .log-warn { color: #fbbf24; } /* é»„è‰²ç³» */
        .log-error { color: #f87171; font-weight: bold; } /* èµ¤ç³» */
        .log-system { color: #9ca3af; } /* ã‚°ãƒ¬ãƒ¼ */
    </style>
</head>
<body>

    <div class="container">
        <h1>Webå‹•ç”»ç·¨é›†ã‚¹ã‚¿ã‚¸ã‚ª</h1>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ -->
        <div class="drop-zone" id="drop-zone">
            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“‚</div>
            <p>ã“ã“ã«å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br><small>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</small></p>
            <input type="file" id="file-input" accept="video/*" style="display: none;">
        </div>

        <div class="grid">
            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div>
                <video id="preview" controls playsinline></video>
                <div id="file-info" style="font-size: 0.85rem; color: #666; margin-top: 10px;"></div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šæ“ä½œãƒ‘ãƒãƒ« -->
            <div>
                <div class="tabs">
                    <div class="tab active" data-target="trim">æ™‚é–“ã‚«ãƒƒãƒˆ</div>
                    <div class="tab" data-target="crop">ç”»é¢åˆ‡æŠœ</div>
                    <div class="tab" data-target="convert">å¤‰æ›ãƒ»ä»–</div>
                </div>

                <!-- 1. æ™‚é–“ãƒˆãƒªãƒŸãƒ³ã‚° -->
                <div id="trim" class="settings-group active">
                    <p style="font-size:0.85rem; color:#666;">å‹•ç”»ã®å‰å¾Œã‚’æŒ‡å®šã—ã¦åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚</p>
                    <div class="row">
                        <div>
                            <label>é–‹å§‹ä½ç½® (ç§’)</label>
                            <input type="number" id="trim-start" value="0" step="0.1" min="0">
                        </div>
                        <div>
                            <label>çµ‚äº†ä½ç½® (ç§’)</label>
                            <input type="number" id="trim-end" value="10" step="0.1" min="0">
                        </div>
                    </div>
                </div>

                <!-- 2. ç”»é¢ã‚¯ãƒ­ãƒƒãƒ— -->
                <div id="crop" class="settings-group">
                    <p style="font-size:0.85rem; color:#666;">ç”»é¢ã®ä¸€éƒ¨ã‚’åˆ‡ã‚Šå–ã‚Šã¾ã™ã€‚</p>
                    <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                    <select id="crop-preset">
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ æ•°å€¤å…¥åŠ›</option>
                        <option value="center-square">ä¸­å¤®ã‚¹ã‚¯ã‚¨ã‚¢ (1:1)</option>
                        <option value="center-43">ä¸­å¤® (4:3)</option>
                        <option value="center-169">ä¸­å¤® (16:9)</option>
                    </select>
                    
                    <div class="row">
                        <div><label>å¹… (W)</label><input type="number" id="crop-w" value="0"></div>
                        <div><label>é«˜ã• (H)</label><input type="number" id="crop-h" value="0"></div>
                    </div>
                    <div class="row">
                        <div><label>X (å·¦)</label><input type="number" id="crop-x" value="0"></div>
                        <div><label>Y (ä¸Š)</label><input type="number" id="crop-y" value="0"></div>
                    </div>
                </div>

                <!-- 3. å¤‰æ›ãƒ»ãã®ä»– -->
                <div id="convert" class="settings-group">
                    <label>æ©Ÿèƒ½é¸æŠ</label>
                    <select id="convert-mode">
                        <option value="gif">GIFã‚¢ãƒ‹ãƒ¡ã«å¤‰æ› (5fps/480px)</option>
                        <option value="mp3">éŸ³å£°ã®ã¿æŠ½å‡º (MP3)</option>
                        <option value="compress">è»½é‡åŒ–ãƒªã‚µã‚¤ã‚º (720p)</option>
                        <option value="mute">éŸ³å£°ã‚’æ¶ˆå»</option>
                    </select>
                    <p style="font-size:0.8rem; color:#ef4444;">â€»GIFå¤‰æ›ã¯å‡¦ç†ãŒé‡ã„ãŸã‚ã€çŸ­ã„å‹•ç”»ã§è©¦ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
                <button id="run-btn" class="btn-primary" disabled>å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„</button>
                
                <!-- é€²æ—è¡¨ç¤º -->
                <div class="progress-container" id="progress-wrap">
                    <progress id="progress-bar" value="0" max="100"></progress>
                    <div class="progress-text" id="progress-text">å¾…æ©Ÿä¸­...</div>
                </div>

                <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
                <a id="download-link" class="download-btn">ä¿å­˜ã™ã‚‹</a>
            </div>
        </div>

        <!-- ç”»é¢å†…ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
        <div class="console-wrapper">
            <div class="console-header">
                <span>ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚° / ã‚¨ãƒ©ãƒ¼å‡ºåŠ›</span>
                <span class="clear-log" onclick="clearLog()">ãƒ­ã‚°æ¶ˆå»</span>
            </div>
            <div id="console-log"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. ç”»é¢å†…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®å®Ÿè£… (æœ€å„ªå…ˆ)
        // ==========================================
        const consoleLogDiv = document.getElementById('console-log');

        function getTimestamp() {
            const now = new Date();
            return now.toTimeString().split(' ')[0]; // HH:MM:SS
        }

        function logToPage(message, type = 'system') {
            const p = document.createElement('div');
            p.className = `log-${type}`;
            p.textContent = `[${getTimestamp()}] ${message}`;
            consoleLogDiv.appendChild(p);
            // å¸¸ã«ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            consoleLogDiv.scrollTop = consoleLogDiv.scrollHeight;
        }

        function clearLog() {
            consoleLogDiv.innerHTML = '';
            logToPage('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', 'system');
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®console.log/errorã‚‚ç”»é¢ã«å‡ºã™ã‚ˆã†ã«ä¸Šæ›¸ã
        const originalLog = console.log;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå«ã¾ã‚Œã‚‹å ´åˆã¯æ–‡å­—åˆ—åŒ–ã‚’è©¦ã¿ã‚‹
            const msg = args.map(arg => (typeof arg === 'object' ? JSON.stringify(arg) : arg)).join(' ');
            logToPage(msg, 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            const msg = args.map(arg => (typeof arg === 'object' ? JSON.stringify(arg) : arg)).join(' ');
            logToPage(msg, 'error');
        };

        // åˆæœŸãƒ­ã‚°
        logToPage('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'system');
        logToPage('User Agent: ' + navigator.userAgent, 'system');


        // ==========================================
        // 2. FFmpeg ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        // ==========================================
        const { createFFmpeg, fetchFile } = FFmpeg;
        let ffmpeg = null;
        let videoFile = null;
        let videoDuration = 0;

        const initFFmpeg = async () => {
            try {
                // corePathã‚’æ˜ç¤ºçš„ã«æŒ‡å®š (CDN)
                ffmpeg = createFFmpeg({
                    corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
                    log: true, // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å†…éƒ¨ãƒ­ã‚°ã‚’å‡ºã™
                    logger: ({ type, message }) => {
                        // FFmpegå†…éƒ¨ãƒ­ã‚°ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                        if (type === 'fferr') {
                            // é€²æ—ãƒ­ã‚°ã®è§£æ (time=XX:XX:XX.XX)
                            const match = message.match(/time=([0-9:.]+)/);
                            if (match && videoDuration > 0) {
                                const t = match[1].split(':');
                                const currentTime = parseFloat(t[0]) * 3600 + parseFloat(t[1]) * 60 + parseFloat(t[2]);
                                const percent = Math.min((currentTime / videoDuration) * 100, 100);
                                updateProgress(percent);
                            }
                            // å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç”»é¢ã«å‡ºã™ã¨å¤šã™ãã‚‹ã®ã§ã€é‡è¦ãªã‚‚ã®ã ã‘å‡ºã™ã‹ã€
                            // ã“ã“ã§ã¯ã‚ãˆã¦å…¨ã¦systemãƒ­ã‚°ã¨ã—ã¦å‡ºã™ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                            // logToPage(`[FFmpeg] ${message}`, 'system'); 
                        }
                    }
                });

                logToPage('FFmpegã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹...', 'info');
                await ffmpeg.load();
                logToPage('FFmpegã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼æº–å‚™OK', 'success');

            } catch (e) {
                console.error('FFmpegèµ·å‹•ã‚¨ãƒ©ãƒ¼:', e);
                logToPage('ã€é‡è¦ã€‘èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        };

        window.addEventListener('load', initFFmpeg);


        // ==========================================
        // 3. UIæ“ä½œãƒ­ã‚¸ãƒƒã‚¯
        // ==========================================
        const els = {
            drop: document.getElementById('drop-zone'),
            input: document.getElementById('file-input'),
            video: document.getElementById('preview'),
            fileInfo: document.getElementById('file-info'),
            tabs: document.querySelectorAll('.tab'),
            groups: document.querySelectorAll('.settings-group'),
            btn: document.getElementById('run-btn'),
            dl: document.getElementById('download-link'),
            progressWrap: document.getElementById('progress-wrap'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            // Inputs
            trimStart: document.getElementById('trim-start'),
            trimEnd: document.getElementById('trim-end'),
            cropPreset: document.getElementById('crop-preset'),
            cropW: document.getElementById('crop-w'),
            cropH: document.getElementById('crop-h'),
            cropX: document.getElementById('crop-x'),
            cropY: document.getElementById('crop-y'),
            convertMode: document.getElementById('convert-mode')
        };

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
        const handleFile = (file) => {
            if (!file) return;
            logToPage(`ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');
            
            videoFile = file;
            const url = URL.createObjectURL(file);
            els.video.src = url;
            els.video.style.display = 'block';
            els.drop.style.display = 'none';
            els.dl.style.display = 'none';
            els.btn.disabled = false;
            els.btn.textContent = 'å‡¦ç†ã‚’å®Ÿè¡Œ';

            els.video.onloadedmetadata = () => {
                videoDuration = els.video.duration;
                els.trimEnd.value = videoDuration.toFixed(1);
                els.fileInfo.textContent = `ã‚µã‚¤ã‚º: ${els.video.videoWidth}x${els.video.videoHeight} / é•·ã•: ${videoDuration.toFixed(1)}ç§’`;
                
                // ã‚¯ãƒ­ãƒƒãƒ—åˆæœŸå€¤
                els.cropW.value = els.video.videoWidth;
                els.cropH.value = els.video.videoHeight;
                els.cropX.value = 0;
                els.cropY.value = 0;

                logToPage(`ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${els.video.videoWidth}x${els.video.videoHeight}, ${videoDuration.toFixed(2)}s`, 'success');
            };

            els.video.onerror = () => {
                logToPage('å‹•ç”»ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
            };
        };

        els.drop.addEventListener('click', () => els.input.click());
        els.input.addEventListener('change', (e) => handleFile(e.target.files[0]));
        els.drop.addEventListener('dragover', (e) => e.preventDefault());
        els.drop.addEventListener('drop', (e) => {
            e.preventDefault();
            handleFile(e.dataTransfer.files[0]);
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        els.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                els.tabs.forEach(t => t.classList.remove('active'));
                els.groups.forEach(g => g.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.add('active');
                logToPage(`ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´: ${tab.textContent}`, 'system');
            });
        });

        // ã‚¯ãƒ­ãƒƒãƒ—ãƒ—ãƒªã‚»ãƒƒãƒˆ
        els.cropPreset.addEventListener('change', (e) => {
            const w = els.video.videoWidth;
            const h = els.video.videoHeight;
            if (!w || !h) return;

            let newW = w, newH = h, newX = 0, newY = 0;

            switch(e.target.value) {
                case 'center-square':
                    const size = Math.min(w, h);
                    newW = size; newH = size;
                    newX = (w - size) / 2; newY = (h - size) / 2;
                    break;
                case 'center-43': // 4:3
                    if (w / h > 4 / 3) {
                        newH = h; newW = h * 4 / 3;
                    } else {
                        newW = w; newH = w * 3 / 4;
                    }
                    newX = (w - newW) / 2; newY = (h - newH) / 2;
                    break;
                case 'center-169': // 16:9
                    if (w / h > 16 / 9) {
                        newH = h; newW = h * 16 / 9;
                    } else {
                        newW = w; newH = w * 9 / 16;
                    }
                    newX = (w - newW) / 2; newY = (h - newH) / 2;
                    break;
            }
            
            els.cropW.value = Math.round(newW);
            els.cropH.value = Math.round(newH);
            els.cropX.value = Math.round(newX);
            els.cropY.value = Math.round(newY);
            
            if (e.target.value !== 'custom') {
                logToPage(`ã‚¯ãƒ­ãƒƒãƒ—ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨: ${e.target.value} -> W:${Math.round(newW)} H:${Math.round(newH)}`, 'info');
            }
        });


        // ==========================================
        // 4. å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
        // ==========================================
        const updateProgress = (percent) => {
            els.progressBar.value = percent;
            els.progressText.textContent = `å‡¦ç†ä¸­... ${Math.round(percent)}%`;
        };

        els.btn.addEventListener('click', async () => {
            if (!ffmpeg || !ffmpeg.isLoaded()) {
                logToPage('FFmpegãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ãƒ‰å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', 'warn');
                return;
            }
            if (!videoFile) {
                logToPage('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warn');
                return;
            }

            const activeTab = document.querySelector('.tab.active').dataset.target;
            
            els.btn.disabled = true;
            els.progressWrap.style.display = 'block';
            els.dl.style.display = 'none';
            updateProgress(0);
            logToPage('=== å‡¦ç†ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹ ===', 'info');

            const inName = 'input_video'; // æ‹¡å¼µå­ãªã—ã§æ›¸ãè¾¼ã¿ã€å¾Œã§è‡ªå‹•åˆ¤å®šã•ã›ã‚‹ã®ã‚‚æ‰‹ã ãŒã€ä¸€æ—¦å›ºå®š
            // ãƒ–ãƒ©ã‚¦ã‚¶ãŒèªè­˜ã—ãŸã‚¿ã‚¤ãƒ—ã‹ã‚‰æ‹¡å¼µå­æ¨æ¸¬ï¼ˆç°¡æ˜“ï¼‰
            const ext = videoFile.name.split('.').pop();
            const inFileName = `input.${ext}`;
            
            let outFileName = 'output.mp4';
            let mimeType = 'video/mp4';
            let args = [];

            try {
                // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿
                logToPage('ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸æ›¸ãè¾¼ã¿ä¸­...', 'system');
                ffmpeg.FS('writeFile', inFileName, await fetchFile(videoFile));

                // 2. ã‚³ãƒãƒ³ãƒ‰æ§‹ç¯‰
                if (activeTab === 'trim') {
                    const start = els.trimStart.value;
                    const end = els.trimEnd.value;
                    const duration = end - start;
                    
                    if (duration <= 0) throw new Error('çµ‚äº†æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');

                    logToPage(`ãƒˆãƒªãƒŸãƒ³ã‚°å®Ÿè¡Œ: ${start}ç§’ ~ ${end}ç§’ (é•·ã•: ${duration}ç§’)`, 'info');
                    // -ss (seek) ã¯å…¥åŠ›ã®å‰ã«ãŠãã“ã¨ã§é«˜é€ŸåŒ–
                    args = [
                        '-ss', start,
                        '-i', inFileName,
                        '-t', String(duration),
                        '-c:v', 'libx264', // H.264ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                        '-preset', 'ultrafast', // é€Ÿåº¦å„ªå…ˆ
                        '-c:a', 'aac',     // éŸ³å£°å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                        outFileName
                    ];

                } else if (activeTab === 'crop') {
                    const w = els.cropW.value;
                    const h = els.cropH.value;
                    const x = els.cropX.value;
                    const y = els.cropY.value;

                    logToPage(`ã‚¯ãƒ­ãƒƒãƒ—å®Ÿè¡Œ: ${w}x${h} (x:${x}, y:${y})`, 'info');
                    args = [
                        '-i', inFileName,
                        '-vf', `crop=${w}:${h}:${x}:${y}`,
                        '-c:v', 'libx264',
                        '-preset', 'ultrafast',
                        '-c:a', 'copy', // éŸ³å£°ã¯ã‚³ãƒ”ãƒ¼
                        outFileName
                    ];

                } else if (activeTab === 'convert') {
                    const mode = els.convertMode.value;
                    logToPage(`å¤‰æ›ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ: ${mode}`, 'info');

                    if (mode === 'gif') {
                        outFileName = 'output.gif';
                        mimeType = 'image/gif';
                        // FPS:5, å¹…:480px ã«åˆ¶é™ã—ã¦ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆã§ç”»è³ªç¢ºä¿
                        args = [
                            '-i', inFileName,
                            '-vf', 'fps=5,scale=480:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse',
                            outFileName
                        ];
                    } else if (mode === 'mp3') {
                        outFileName = 'output.mp3';
                        mimeType = 'audio/mpeg';
                        args = ['-i', inFileName, '-q:a', '0', '-map', 'a', outFileName];
                    } else if (mode === 'compress') {
                        // 720p, CRF 28 (å°‘ã—ç”»è³ªè½ã¨ã™), ultrafast
                        args = [
                            '-i', inFileName,
                            '-vf', 'scale=-1:720',
                            '-c:v', 'libx264',
                            '-crf', '28',
                            '-preset', 'ultrafast',
                            '-c:a', 'aac',
                            outFileName
                        ];
                    } else if (mode === 'mute') {
                        // éŸ³å£°å‰Šé™¤ (-an)
                        args = ['-i', inFileName, '-an', '-c:v', 'copy', outFileName];
                    }
                }

                // 3. å®Ÿè¡Œ
                logToPage(`ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ: ffmpeg ${args.join(' ')}`, 'system');
                await ffmpeg.run(...args);

                logToPage('FFmpegå‡¦ç†å®Œäº†ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­...', 'success');

                // 4. çµæœå–å¾—
                const data = ffmpeg.FS('readFile', outFileName);
                const blob = new Blob([data.buffer], { type: mimeType });
                const url = URL.createObjectURL(blob);

                els.dl.href = url;
                els.dl.download = `edited_${activeTab}_${getTimestamp().replace(/:/g,'')}.${outFileName.split('.').pop()}`;
                els.dl.style.display = 'block';
                els.dl.textContent = 'å®Œæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹';
                
                updateProgress(100);
                els.progressText.textContent = 'å®Œäº†ï¼';
                logToPage('ã™ã¹ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸã€‚', 'success');

            } catch (err) {
                console.error(err);
                logToPage(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${err.message}`, 'error');
                els.progressText.textContent = 'ã‚¨ãƒ©ãƒ¼';
            } finally {
                els.btn.disabled = false;
                // ãƒ¡ãƒ¢ãƒªæƒé™¤ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å®Ÿè¡Œï¼‰
                try {
                    if (ffmpeg.FS('readdir', '/').includes(inFileName)) ffmpeg.FS('unlink', inFileName);
                    if (ffmpeg.FS('readdir', '/').includes(outFileName)) ffmpeg.FS('unlink', outFileName);
                } catch(cleanupErr) {
                    // ç„¡è¦–
                }
            }
        });

    </script>
</body>
</html>
