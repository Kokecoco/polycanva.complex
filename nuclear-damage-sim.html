<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¸è¢«å®³æƒ³å®šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (æ—¥æœ¬åœ°åŸŸç‰ˆ)</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Helvetica Neue", Arial, sans-serif; display: flex; height: 100vh; }
        #sidebar { width: 380px; background: #f9f9f9; padding: 20px; box-shadow: 2px 0 8px rgba(0,0,0,0.1); overflow-y: auto; z-index: 500; }
        #map { flex-grow: 1; height: 100%; cursor: crosshair; }
        
        h2 { margin-top: 0; font-size: 1.1rem; color: #333; border-bottom: 2px solid #555; padding-bottom: 10px; }
        .control-group { margin-bottom: 15px; border-bottom: 1px dashed #ddd; padding-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; }
        select, input[type="number"], input[type="range"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        
        .radio-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .radio-group label { font-weight: normal; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 4px; }

        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .checkbox-group input { width: auto; margin: 0; cursor: pointer; }
        .checkbox-group label { margin: 0; font-weight: normal; cursor: pointer; font-size: 0.9rem; }

        button { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: background 0.2s; }
        button.action-btn { background-color: #d32f2f; color: white; margin-top: 10px; font-size: 1.1rem; box-shadow: 0 4px 0 #b71c1c; }
        button.action-btn:active { box-shadow: 0 2px 0 #b71c1c; transform: translateY(2px); }
        button.clear-btn { background-color: #555; color: white; margin-top: 5px; font-size: 0.8rem; }
        
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 8px; }
        button.preset { background-color: #ddd; color: #333; font-size: 0.75rem; padding: 6px; }
        button.preset:hover { background-color: #bbb; }

        .result-box { background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .stat-value { font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        .stat-dead { color: #d32f2f; }
        .stat-injured { color: #f57c00; }
        .stat-fallout { color: #555; font-size: 0.9rem; margin-top:5px; border-top:1px dashed #eee; padding-top:5px;}

        .list-container { font-size: 0.8rem; color: #555; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-top: 5px; background: #fff; }
        .list-item { padding: 3px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
        .infra-destroyed { color: red; font-weight: bold; }
        .infra-damaged { color: orange; }

        .target-list { margin-bottom: 10px; font-size: 0.8rem; color: #d32f2f; font-weight: bold; }
        
        /* å…è²¬äº‹é …ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #disclaimerModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 650px; max-height: 85vh;
            padding: 30px; border-radius: 8px; overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-size: 0.9rem; line-height: 1.6;
        }
        .modal-content h3 { margin-top: 0; color: #333; border-bottom: 2px solid #d32f2f; padding-bottom: 10px; }
        .modal-content p { margin-bottom: 15px; text-align: justify; }
        .modal-btn {
            background-color: #333; color: white; padding: 12px 20px;
            border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; width: 100%; margin-top: 10px;
        }
        .modal-btn:hover { background-color: #555; }

        @media (max-width: 600px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 50%; box-sizing: border-box; }
            #map { height: 50%; }
        }
    </style>
</head>
<body>

<!-- å…è²¬äº‹é …ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="disclaimerModal">
    <div class="modal-content">
        <h3>æœ¬ã‚µã‚¤ãƒˆã®åˆ©ç”¨ã«ã¤ã„ã¦ï¼ˆå…è²¬äº‹é …ï¼‰</h3>
        
        <p><strong>1. ç›®çš„ã¨ç†å¿µ</strong><br>
        æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ã€æ ¸å…µå™¨ãŒä½¿ç”¨ã•ã‚ŒãŸå ´åˆã®è¢«å®³è¦æ¨¡ã‚’åœ°å›³ä¸Šã§è¦–è¦šåŒ–ã—ã€ãã®ç ´å£ŠåŠ›ã®ç”šå¤§ã•ã¨å±é™ºæ€§ã‚’å®¢è¦³çš„ã«ç†è§£ã™ã‚‹ãŸã‚ã®å­¦ç¿’ãƒ»ç ”ç©¶ç”¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚æˆ¦äº‰è¡Œç‚ºã€æš´åŠ›ã€ã¾ãŸã¯æ ¸å…µå™¨ã®ä½¿ç”¨ã‚’è‚¯å®šãƒ»åŠ©é•·ãƒ»æ¨å¥¨ã™ã‚‹ç›®çš„ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

        <p><strong>2. ãƒ‡ãƒ¼ã‚¿ã®ç²¾åº¦ã¨è¨ˆç®—ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦</strong><br>
        æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ç‰©ç†å­¦çš„ãªã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰‡ãŠã‚ˆã³çµ±è¨ˆçš„ãªäººå£åˆ†å¸ƒãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸã€Œç°¡æ˜“çš„ãªæ¦‚ç®—ãƒ¢ãƒ‡ãƒ«ã€ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®è¢«å®³ã¯è©³ç´°ãªæ°—è±¡æ¡ä»¶ã€åœ°å½¢ï¼ˆå±±åœ°ãƒ»è°·ï¼‰ã€å»ºç‰©ã®æ§‹é€ ã€é¿é›£çŠ¶æ³ãªã©ã«å¤§ããå·¦å³ã•ã‚Œã‚‹ãŸã‚ã€ç®—å‡ºã•ã‚Œã‚‹æ•°å€¤ã‚„ç¯„å›²ã¯ã‚ãã¾ã§ç†è«–ä¸Šã®ç›®å®‰ã§ã‚ã‚Šã€æ­£ç¢ºæ€§ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€AIã§ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ãªã®ã§ãƒ‡ãƒ¼ã‚¿ã‚‚ãã®ã¾ã¾ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ç§ã¯ç¢ºèªã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚ä¸æ­£ç¢ºãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>

        <p><strong>3. è¨ˆç®—å¯¾è±¡ç¯„å›²ã«ã¤ã„ã¦ï¼ˆé‡è¦ï¼‰</strong><br>
        æœ¬ãƒ„ãƒ¼ãƒ«ã¯<strong>ã€Œæ—¥æœ¬å›½å†…ã®äººå£ãƒ‡ãƒ¼ã‚¿ã€ã®ã¿</strong>ã‚’ä½¿ç”¨ã—ã¦è¨ˆç®—ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚è¢«å®³ç¯„å›²ãŒå›½å¢ƒã‚„æµ·ä¸Šã¸åºƒãŒã£ãŸå ´åˆã€æ—¥æœ¬å›½å¤–ã®è¢«å®³çŠ¶æ³ã‚„ã€è¿‘éš£è«¸å›½ã¸ã®æ”¾å°„æ€§ç‰©è³ªã®æ‹¡æ•£ç­‰ã¯è¨ˆç®—ã«å«ã¾ã‚Œã¾ã›ã‚“ã€‚å›½å¤–ã«è¢«å®³ãŒåŠã°ãªã„ã“ã¨ã‚’ç¤ºå”†ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

        <p><strong>4. å…è²¬äº‹é …ãƒ»ãŠå•ã„åˆã‚ã›</strong><br>
        æœ¬ãƒ„ãƒ¼ãƒ«ã®åˆ©ç”¨çµæœã€ã¾ãŸã¯åˆ©ç”¨ã«ä¼´ã„ç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã«ã¤ã„ã¦ã‚‚ã€è£½ä½œè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚ã¾ãŸã€æœ¬ãƒ„ãƒ¼ãƒ«ã¯ç¾çŠ¶æœ‰å§¿ã§ã®æä¾›ã§ã‚ã‚Šã€ã”è³ªå•ãƒ»ã”æ„è¦‹ãƒ»æŠ€è¡“çš„ãªãŠå•ã„åˆã‚ã›ç­‰ã«ã¯ã€ç†ç”±ã®å¦‚ä½•ã‚’å•ã‚ãšä¸€åˆ‡å›ç­”ã„ãŸã—ã‹ã­ã¾ã™ã€‚</p>

        <button class="modal-btn" onclick="closeModal()">ä¸Šè¨˜ã‚’ç†è§£ã—ã€åŒæ„ã—ã¦åˆ©ç”¨ã™ã‚‹</button>
    </div>
</div>

<div id="sidebar">
    <h2>ğŸ‡¯ğŸ‡µ æ ¸è¢«å®³æƒ³å®šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼<br><span style="font-size:0.7rem; color:#666;">Nuclear Damage Simulator (Japan Region)</span></h2>
    <p style="font-size:0.75rem; color:#666;">
        ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰‡ã¨äººå£åˆ†å¸ƒãƒ¢ãƒ‡ãƒ«ã«åŸºã¥ãè¢«å®³è©¦ç®—ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br>
        â€»æ•°å€¤ã¯å…¨ã¦æ¦‚ç®—ã§ã™ã€‚åœ°å½¢ã‚„å»ºç‰©ã¯è€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
    </p>
    
    <div class="control-group">
        <label>1. çˆ†ç™ºãƒ»æ™‚é–“è¨­å®š</label>
        <div class="radio-group">
            <label><input type="radio" name="burstType" value="air" checked> ç©ºä¸­çˆ†ç™º (åºƒç¯„å›²)</label>
            <label><input type="radio" name="burstType" value="surface"> åœ°ä¸Šçˆ†ç™º (å±€æ‰€/æ±šæŸ“)</label>
        </div>
        <div class="radio-group">
            <label><input type="radio" name="timeOfDay" value="day" checked> â˜€ï¸ æ˜¼é–“ (éƒ½å¿ƒé›†ä¸­)</label>
            <label><input type="radio" name="timeOfDay" value="night"> ğŸŒ™ å¤œé–“ (éƒŠå¤–åˆ†æ•£)</label>
        </div>
        
        <label>çˆ†ç™ºå¨åŠ› (ã‚­ãƒ­ãƒˆãƒ³)</label>
        <input type="number" id="yieldInput" value="150">
        <div class="preset-grid">
            <button class="preset" onclick="setYield(15)">åºƒå³¶ç´š (15kt)</button>
            <button class="preset" onclick="setYield(150)">2017å¹´å®Ÿé¨“è¦æ¨¡ (150kt)</button>
            <button class="preset" onclick="setYield(300)">ç¾ä»£ã®æˆ¦ç•¥å…µå™¨ (300kt)</button>
            <button class="preset" onclick="setYield(50000)">å²ä¸Šæœ€å¤§ã®å®Ÿé¨“ (50Mt)</button>
        </div>
    </div>

    <div class="control-group">
        <label>2. é¢¨å‘ã (æ”¾å°„æ€§é™ä¸‹ç‰©)</label>
        <div class="checkbox-group">
            <input type="checkbox" id="noWind" onchange="toggleWindControl(this.checked)">
            <label for="noWind">ç„¡é¢¨ (æ‹¡æ•£ãªã—)</label>
        </div>
        <input type="range" id="windDir" min="0" max="360" value="135" oninput="updateWindLabel(this.value)">
        <div style="font-size:0.8rem; text-align:center;">
            é¢¨å‘ã: <span id="windLabel">135</span>Â°
        </div>
        <p style="font-size:0.7rem; color:#666; margin-top:5px;">
            â€»ã€Œåœ°ä¸Šçˆ†ç™ºã€ã¾ãŸã¯ã€Œå·¨å¤§ãªå¼¾é ­ã€ã®å ´åˆã®ã¿ã€é¢¨ä¸‹ã«æ”¾å°„æ€§é™ä¸‹ç‰©ï¼ˆæ­»ã®ç°ï¼‰ã®å½±éŸ¿ç¯„å›²ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </p>
    </div>

    <div class="control-group">
        <label>3. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š (åœ°å›³æ“ä½œ)</label>
        <p style="font-size:0.75rem; margin:5px 0; color:#444;">
            â— åœ°å›³ã‚¯ãƒªãƒƒã‚¯: çˆ†å¿ƒåœ°ã‚’è¿½åŠ <br>â— <span style="color:red;">èµ¤ãƒãƒ¼ã‚«ãƒ¼</span>ã‚¯ãƒªãƒƒã‚¯: å€‹åˆ¥ã«å‰Šé™¤
        </p>
        <div class="target-list">ã‚»ãƒƒãƒˆã•ã‚ŒãŸå¼¾é ­æ•°: <span id="targetCount">0</span> ç™º</div>
        <button class="clear-btn" onclick="clearTargets()">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå…¨æ¶ˆå»</button>
    </div>

    <button class="action-btn" onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>

    <div id="results" class="result-box" style="display:none;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:5px; font-size:1rem;">è¢«å®³æ¨å®šç·æ•° (æ—¥æœ¬å›½å†…)</h3>
        <div class="stat-line"><span>æ­»è€…æ•° (æ¨è¨ˆ):</span> <span id="deadCount" class="stat-value stat-dead">-</span></div>
        <div class="stat-line"><span>è² å‚·è€…æ•° (æ¨è¨ˆ):</span> <span id="injuredCount" class="stat-value stat-injured">-</span></div>
        <div class="stat-fallout">â˜¢ï¸ æ®‹ç•™æ”¾å°„èƒ½ å½±éŸ¿åœäººå£: <br><span id="falloutPop" style="font-weight:bold;">-</span> äºº</div>
        
        <div style="margin-top:10px; font-weight:bold; font-size:0.8rem;">éƒ½å¸‚åˆ¥ãƒ»åœ°åŸŸåˆ¥ å†…è¨³:</div>
        <div id="hitAreas" class="list-container"></div>
        
        <div style="margin-top:10px; font-weight:bold; font-size:0.8rem;">é‡è¦æ–½è¨­ã¸ã®å½±éŸ¿:</div>
        <div id="infraList" class="list-container"></div>
    </div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    function closeModal() { document.getElementById('disclaimerModal').style.display = 'none'; }
    
    function updateWindLabel(val) { 
        if(!document.getElementById('noWind').checked) {
            document.getElementById('windLabel').innerText = val; 
        }
    }

    function toggleWindControl(isNoWind) {
        const slider = document.getElementById('windDir');
        const label = document.getElementById('windLabel');
        if (isNoWind) {
            slider.disabled = true;
            slider.style.opacity = 0.5;
            label.innerText = "-";
        } else {
            slider.disabled = false;
            slider.style.opacity = 1;
            label.innerText = slider.value;
        }
    }

    // --- éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ (åºƒåŸŸèƒŒæ™¯ç”¨) ---
    const prefectures = [
        { name: "åŒ—æµ·é“", lat: 43.5, lon: 142.5, pop: 5100000, radius: 150 },
        { name: "é’æ£®çœŒ", lat: 40.8, lon: 140.7, pop: 1200000, radius: 50 },
        { name: "å²©æ‰‹çœŒ", lat: 39.7, lon: 141.1, pop: 1180000, radius: 60 },
        { name: "å®®åŸçœŒ", lat: 38.3, lon: 140.9, pop: 2280000, radius: 40 },
        { name: "ç§‹ç”°çœŒ", lat: 39.7, lon: 140.1, pop: 940000, radius: 50 },
        { name: "å±±å½¢çœŒ", lat: 38.2, lon: 140.3, pop: 1050000, radius: 50 },
        { name: "ç¦å³¶çœŒ", lat: 37.4, lon: 140.4, pop: 1800000, radius: 60 },
        { name: "èŒ¨åŸçœŒ", lat: 36.3, lon: 140.4, pop: 2830000, radius: 50 },
        { name: "æ ƒæœ¨çœŒ", lat: 36.5, lon: 139.8, pop: 1920000, radius: 40 },
        { name: "ç¾¤é¦¬çœŒ", lat: 36.4, lon: 139.1, pop: 1920000, radius: 40 },
        { name: "åŸ¼ç‰çœŒ", lat: 36.0, lon: 139.5, pop: 7330000, radius: 30 },
        { name: "åƒè‘‰çœŒ", lat: 35.5, lon: 140.2, pop: 6270000, radius: 40 },
        { name: "æ±äº¬éƒ½", lat: 35.7, lon: 139.5, pop: 14000000, radius: 20 },
        { name: "ç¥å¥ˆå·çœŒ", lat: 35.4, lon: 139.5, pop: 9230000, radius: 20 },
        { name: "æ–°æ½ŸçœŒ", lat: 37.4, lon: 138.9, pop: 2190000, radius: 80 },
        { name: "å¯Œå±±çœŒ", lat: 36.7, lon: 137.2, pop: 1030000, radius: 30 },
        { name: "çŸ³å·çœŒ", lat: 36.6, lon: 136.6, pop: 1130000, radius: 40 },
        { name: "ç¦äº•çœŒ", lat: 35.9, lon: 136.2, pop: 760000, radius: 40 },
        { name: "å±±æ¢¨çœŒ", lat: 35.6, lon: 138.6, pop: 800000, radius: 30 },
        { name: "é•·é‡çœŒ", lat: 36.1, lon: 138.0, pop: 2030000, radius: 70 },
        { name: "å²é˜œçœŒ", lat: 35.7, lon: 136.7, pop: 1970000, radius: 60 },
        { name: "é™å²¡çœŒ", lat: 34.9, lon: 138.3, pop: 3600000, radius: 60 },
        { name: "æ„›çŸ¥çœŒ", lat: 35.1, lon: 137.0, pop: 7520000, radius: 40 },
        { name: "ä¸‰é‡çœŒ", lat: 34.7, lon: 136.5, pop: 1760000, radius: 50 },
        { name: "æ»‹è³€çœŒ", lat: 35.2, lon: 136.1, pop: 1410000, radius: 30 },
        { name: "äº¬éƒ½åºœ", lat: 35.2, lon: 135.6, pop: 2560000, radius: 40 },
        { name: "å¤§é˜ªåºœ", lat: 34.7, lon: 135.5, pop: 8800000, radius: 20 },
        { name: "å…µåº«çœŒ", lat: 35.0, lon: 134.9, pop: 5430000, radius: 60 },
        { name: "å¥ˆè‰¯çœŒ", lat: 34.5, lon: 135.8, pop: 1320000, radius: 30 },
        { name: "å’Œæ­Œå±±çœŒ", lat: 33.9, lon: 135.4, pop: 910000, radius: 50 },
        { name: "é³¥å–çœŒ", lat: 35.4, lon: 133.9, pop: 550000, radius: 40 },
        { name: "å³¶æ ¹çœŒ", lat: 35.0, lon: 132.5, pop: 660000, radius: 60 },
        { name: "å²¡å±±çœŒ", lat: 34.9, lon: 133.8, pop: 1870000, radius: 50 },
        { name: "åºƒå³¶çœŒ", lat: 34.6, lon: 132.8, pop: 2790000, radius: 50 },
        { name: "å±±å£çœŒ", lat: 34.2, lon: 131.6, pop: 1330000, radius: 50 },
        { name: "å¾³å³¶çœŒ", lat: 33.9, lon: 134.4, pop: 720000, radius: 40 },
        { name: "é¦™å·çœŒ", lat: 34.2, lon: 134.0, pop: 940000, radius: 30 },
        { name: "æ„›åª›çœŒ", lat: 33.6, lon: 132.8, pop: 1320000, radius: 50 },
        { name: "é«˜çŸ¥çœŒ", lat: 33.5, lon: 133.4, pop: 680000, radius: 60 },
        { name: "ç¦å²¡çœŒ", lat: 33.6, lon: 130.6, pop: 5100000, radius: 40 },
        { name: "ä½è³€çœŒ", lat: 33.3, lon: 130.1, pop: 800000, radius: 30 },
        { name: "é•·å´çœŒ", lat: 33.0, lon: 129.8, pop: 1300000, radius: 50 },
        { name: "ç†Šæœ¬çœŒ", lat: 32.6, lon: 130.8, pop: 1730000, radius: 50 },
        { name: "å¤§åˆ†çœŒ", lat: 33.2, lon: 131.4, pop: 1120000, radius: 50 },
        { name: "å®®å´çœŒ", lat: 32.1, lon: 131.3, pop: 1060000, radius: 60 },
        { name: "é¹¿å…å³¶çœŒ", lat: 31.6, lon: 130.5, pop: 1580000, radius: 60 },
        { name: "æ²–ç¸„çœŒ", lat: 26.5, lon: 127.9, pop: 1460000, radius: 50 }
    ];

    // --- ä¸»è¦éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿ ---
    const cities = [
        { name: "æœ­å¹Œ", pref: "åŒ—æµ·é“", lat: 43.0618, lon: 141.3545, pop: 1970000, radius: 12 },
        { name: "æ—­å·", pref: "åŒ—æµ·é“", lat: 43.7706, lon: 142.3649, pop: 330000, radius: 7 },
        { name: "å‡½é¤¨", pref: "åŒ—æµ·é“", lat: 41.7687, lon: 140.7288, pop: 250000, radius: 6 },
        { name: "è‹«å°ç‰§", pref: "åŒ—æµ·é“", lat: 42.6366, lon: 141.6033, pop: 170000, radius: 6 },
        { name: "é‡§è·¯", pref: "åŒ—æµ·é“", lat: 42.9849, lon: 144.3817, pop: 160000, radius: 6 },
        { name: "å¸¯åºƒ", pref: "åŒ—æµ·é“", lat: 42.9239, lon: 143.1961, pop: 165000, radius: 6 },
        { name: "ä»™å°", pref: "å®®åŸçœŒ", lat: 38.2682, lon: 140.8694, pop: 1090000, radius: 10 },
        { name: "é’æ£®", pref: "é’æ£®çœŒ", lat: 40.8244, lon: 140.7400, pop: 270000, radius: 6 },
        { name: "ç››å²¡", pref: "å²©æ‰‹çœŒ", lat: 39.7020, lon: 141.1545, pop: 290000, radius: 6 },
        { name: "ç§‹ç”°", pref: "ç§‹ç”°çœŒ", lat: 39.7186, lon: 140.1024, pop: 300000, radius: 6 },
        { name: "å±±å½¢", pref: "å±±å½¢çœŒ", lat: 38.2554, lon: 140.3396, pop: 240000, radius: 6 },
        { name: "ç¦å³¶", pref: "ç¦å³¶çœŒ", lat: 37.7608, lon: 140.4748, pop: 280000, radius: 6 },
        { name: "éƒ¡å±±", pref: "ç¦å³¶çœŒ", lat: 37.3976, lon: 140.3883, pop: 320000, radius: 7 },
        { name: "ã„ã‚ã", pref: "ç¦å³¶çœŒ", lat: 37.0504, lon: 140.8877, pop: 330000, radius: 8 },
        { name: "æ±äº¬(23åŒº)", pref: "æ±äº¬éƒ½", lat: 35.6895, lon: 139.6917, pop: 9700000, radius: 15 },
        { name: "æ¨ªæµœ", pref: "ç¥å¥ˆå·çœŒ", lat: 35.4437, lon: 139.6380, pop: 3770000, radius: 12 },
        { name: "å·å´", pref: "ç¥å¥ˆå·çœŒ", lat: 35.5304, lon: 139.7030, pop: 1540000, radius: 9 },
        { name: "ç›¸æ¨¡åŸ", pref: "ç¥å¥ˆå·çœŒ", lat: 35.5713, lon: 139.3731, pop: 720000, radius: 8 },
        { name: "ã•ã„ãŸã¾", pref: "åŸ¼ç‰çœŒ", lat: 35.8616, lon: 139.6455, pop: 1320000, radius: 10 },
        { name: "åƒè‘‰", pref: "åƒè‘‰çœŒ", lat: 35.6074, lon: 140.1065, pop: 970000, radius: 9 },
        { name: "å®‡éƒ½å®®", pref: "æ ƒæœ¨çœŒ", lat: 36.5551, lon: 139.8828, pop: 520000, radius: 8 },
        { name: "æ°´æˆ¸", pref: "èŒ¨åŸçœŒ", lat: 36.3659, lon: 140.4715, pop: 270000, radius: 6 },
        { name: "å‰æ©‹", pref: "ç¾¤é¦¬çœŒ", lat: 36.3895, lon: 139.0634, pop: 330000, radius: 6 },
        { name: "é«˜å´", pref: "ç¾¤é¦¬çœŒ", lat: 36.3219, lon: 139.0033, pop: 370000, radius: 6 },
        { name: "æ–°æ½Ÿ", pref: "æ–°æ½ŸçœŒ", lat: 37.9162, lon: 139.0364, pop: 780000, radius: 9 },
        { name: "é‡‘æ²¢", pref: "çŸ³å·çœŒ", lat: 36.5613, lon: 136.6562, pop: 460000, radius: 7 },
        { name: "å¯Œå±±", pref: "å¯Œå±±çœŒ", lat: 36.6959, lon: 137.2137, pop: 410000, radius: 7 },
        { name: "é•·é‡", pref: "é•·é‡çœŒ", lat: 36.6486, lon: 138.1942, pop: 370000, radius: 7 },
        { name: "åå¤å±‹", pref: "æ„›çŸ¥çœŒ", lat: 35.1815, lon: 136.9066, pop: 2320000, radius: 12 },
        { name: "è±Šç”°", pref: "æ„›çŸ¥çœŒ", lat: 35.0825, lon: 137.1560, pop: 420000, radius: 8 },
        { name: "é™å²¡", pref: "é™å²¡çœŒ", lat: 34.9756, lon: 138.3828, pop: 690000, radius: 8 },
        { name: "æµœæ¾", pref: "é™å²¡çœŒ", lat: 34.7108, lon: 137.7261, pop: 780000, radius: 9 },
        { name: "å²é˜œ", pref: "å²é˜œçœŒ", lat: 35.4233, lon: 136.7607, pop: 400000, radius: 7 },
        { name: "å¤§é˜ª", pref: "å¤§é˜ªåºœ", lat: 34.6937, lon: 135.5023, pop: 2750000, radius: 10 },
        { name: "å º", pref: "å¤§é˜ªåºœ", lat: 34.5733, lon: 135.4830, pop: 820000, radius: 8 },
        { name: "äº¬éƒ½", pref: "äº¬éƒ½åºœ", lat: 35.0116, lon: 135.7681, pop: 1470000, radius: 9 },
        { name: "ç¥æˆ¸", pref: "å…µåº«çœŒ", lat: 34.6901, lon: 135.1955, pop: 1520000, radius: 10 },
        { name: "å¥ˆè‰¯", pref: "å¥ˆè‰¯çœŒ", lat: 34.6851, lon: 135.8048, pop: 350000, radius: 6 },
        { name: "å’Œæ­Œå±±", pref: "å’Œæ­Œå±±çœŒ", lat: 34.2259, lon: 135.1675, pop: 350000, radius: 6 },
        { name: "å¤§æ´¥", pref: "æ»‹è³€çœŒ", lat: 35.0177, lon: 135.8549, pop: 340000, radius: 6 },
        { name: "åºƒå³¶", pref: "åºƒå³¶çœŒ", lat: 34.3853, lon: 132.4553, pop: 1190000, radius: 9 },
        { name: "ç¦å±±", pref: "åºƒå³¶çœŒ", lat: 34.4859, lon: 133.3623, pop: 460000, radius: 7 },
        { name: "å²¡å±±", pref: "å²¡å±±çœŒ", lat: 34.6551, lon: 133.9195, pop: 720000, radius: 8 },
        { name: "æ¾æ±Ÿ", pref: "å³¶æ ¹çœŒ", lat: 35.4681, lon: 133.0485, pop: 200000, radius: 5 },
        { name: "é³¥å–", pref: "é³¥å–çœŒ", lat: 35.5011, lon: 134.2351, pop: 180000, radius: 5 },
        { name: "é«˜æ¾", pref: "é¦™å·çœŒ", lat: 34.3428, lon: 134.0466, pop: 420000, radius: 6 },
        { name: "æ¾å±±", pref: "æ„›åª›çœŒ", lat: 33.8392, lon: 132.7656, pop: 510000, radius: 7 },
        { name: "é«˜çŸ¥", pref: "é«˜çŸ¥çœŒ", lat: 33.5588, lon: 133.5311, pop: 320000, radius: 6 },
        { name: "å¾³å³¶", pref: "å¾³å³¶çœŒ", lat: 34.0702, lon: 134.5548, pop: 250000, radius: 6 },
        { name: "ç¦å²¡", pref: "ç¦å²¡çœŒ", lat: 33.5902, lon: 130.4017, pop: 1600000, radius: 10 },
        { name: "åŒ—ä¹å·", pref: "ç¦å²¡çœŒ", lat: 33.8835, lon: 130.8752, pop: 930000, radius: 9 },
        { name: "ä¹…ç•™ç±³", pref: "ç¦å²¡çœŒ", lat: 33.3192, lon: 130.5083, pop: 300000, radius: 6 },
        { name: "ç†Šæœ¬", pref: "ç†Šæœ¬çœŒ", lat: 32.8031, lon: 130.7079, pop: 740000, radius: 8 },
        { name: "é¹¿å…å³¶", pref: "é¹¿å…å³¶çœŒ", lat: 31.5966, lon: 130.5571, pop: 600000, radius: 8 },
        { name: "å¤§åˆ†", pref: "å¤§åˆ†çœŒ", lat: 33.2382, lon: 131.6126, pop: 480000, radius: 7 },
        { name: "é•·å´", pref: "é•·å´çœŒ", lat: 32.7503, lon: 129.8779, pop: 400000, radius: 6 },
        { name: "å®®å´", pref: "å®®å´çœŒ", lat: 31.9076, lon: 131.4202, pop: 400000, radius: 7 },
        { name: "ä½è³€", pref: "ä½è³€çœŒ", lat: 33.2635, lon: 130.3008, pop: 230000, radius: 6 },
        { name: "é‚£è¦‡", pref: "æ²–ç¸„çœŒ", lat: 26.2124, lon: 127.6809, pop: 320000, radius: 6 }
    ];

    // --- ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ¼ã‚¿ ---
    const infrastructures = [
        { name: "é¦–ç›¸å®˜é‚¸ãƒ»å›½ä¼š", type: "government", lat: 35.6758, lon: 139.7448 },
        { name: "é˜²è¡›çœ (å¸‚ãƒ¶è°·)", type: "base", lat: 35.6925, lon: 139.7289 },
        { name: "æ¨ªé ˆè³€åŸºåœ° (ç±³æµ·è»)", type: "base", lat: 35.2923, lon: 139.6641 },
        { name: "æ¨ªç”°åŸºåœ°", type: "base", lat: 35.7397, lon: 139.3409 },
        { name: "ä¸‰æ²¢åŸºåœ°", type: "base", lat: 40.7020, lon: 141.3688 },
        { name: "å˜‰æ‰‹ç´åŸºåœ°", type: "base", lat: 26.3556, lon: 127.7679 },
        { name: "å²©å›½åŸºåœ°", type: "base", lat: 34.1444, lon: 132.2356 },
        { name: "ä½ä¸–ä¿åŸºåœ°", type: "base", lat: 33.1672, lon: 129.7153 },
        { name: "æµœå²¡åŸç™º", type: "plant", lat: 34.6231, lon: 138.1396 },
        { name: "æŸå´åˆˆç¾½åŸç™º", type: "plant", lat: 37.4287, lon: 138.5962 },
        { name: "ç„æµ·åŸç™º", type: "plant", lat: 33.5152, lon: 129.8373 },
        { name: "å·å†…åŸç™º", type: "plant", lat: 31.8358, lon: 130.1837 },
        { name: "å¤§é£¯ãƒ»é«˜æµœåŸç™ºç¾¤", type: "plant", lat: 35.5414, lon: 135.6521 },
        { name: "å…­ãƒ¶æ‰€å†å‡¦ç†å·¥å ´", type: "plant", lat: 40.9576, lon: 141.3283 },
        { name: "ç¦å³¶ç¬¬ä¸€åŸç™ºè·¡", type: "plant", lat: 37.4211, lon: 141.0328 },
        { name: "ä¼Šæ–¹åŸç™º", type: "plant", lat: 33.4908, lon: 132.3112 },
        { name: "æ³ŠåŸç™º", type: "plant", lat: 43.0410, lon: 140.5132 },
        { name: "å¥³å·åŸç™º", type: "plant", lat: 38.4009, lon: 141.4996 },
        { name: "å³¶æ ¹åŸç™º", type: "plant", lat: 35.5393, lon: 132.9996 },
        { name: "ç¾½ç”°ç©ºæ¸¯", type: "airport", lat: 35.5494, lon: 139.7798 },
        { name: "æˆç”°ç©ºæ¸¯", type: "airport", lat: 35.7720, lon: 140.3929 },
        { name: "é–¢è¥¿å›½éš›ç©ºæ¸¯", type: "airport", lat: 34.4320, lon: 135.2304 },
        { name: "ä¸­éƒ¨å›½éš›ç©ºæ¸¯", type: "airport", lat: 34.8584, lon: 136.8046 },
        { name: "æ–°åƒæ­³ç©ºæ¸¯", type: "airport", lat: 42.7752, lon: 141.6923 },
        { name: "ç¦å²¡ç©ºæ¸¯", type: "airport", lat: 33.5859, lon: 130.4506 },
        { name: "é‚£è¦‡ç©ºæ¸¯", type: "airport", lat: 26.2048, lon: 127.6458 }
    ];

    // --- ãƒ¡ãƒƒã‚·ãƒ¥ç”Ÿæˆ ---
    let populationNodes = [];

    function generateGaussianHybridMesh() {
        populationNodes = [];
        
        // 1. éƒ½é“åºœçœŒèƒŒæ™¯ (Rural)
        prefectures.forEach(pref => {
            const citiesInPref = cities.filter(c => c.pref === pref.name);
            const urbanPopSum = citiesInPref.reduce((sum, c) => sum + c.pop, 0);
            let ruralPop = pref.pop - urbanPopSum;
            if (ruralPop < 0) ruralPop = 0;

            const ruralPoints = 50; 
            for(let i=0; i<ruralPoints; i++) {
                const r = pref.radius * Math.sqrt(Math.random());
                const theta = Math.random() * 2 * Math.PI;
                const latOffset = r * Math.cos(theta) / 111.0;
                const lonOffset = r * Math.sin(theta) / (111.0 * Math.cos(pref.lat * Math.PI / 180));
                
                populationNodes.push({
                    name: `${pref.name}(å…¨åŸŸ)`,
                    type: 'rural',
                    lat: pref.lat + latOffset,
                    lon: pref.lon + lonOffset,
                    pop: ruralPop / ruralPoints
                });
            }
        });

        // 2. ä¸»è¦éƒ½å¸‚ (Urban - Gaussian)
        cities.forEach(city => {
            const sigma = city.radius / 2.0; 
            let points = [];
            points.push({ dist: 0, lat: city.lat, lon: city.lon });
            
            const rings = 10; 
            for (let i = 1; i <= rings; i++) {
                const rRatio = i / rings; 
                const distKm = city.radius * 1.2 * rRatio;
                const pointsInRing = Math.floor(6 * i);
                const latPerKm = 1 / 111.0;
                const lonPerKm = 1 / (111.0 * Math.cos(city.lat * Math.PI / 180));

                for (let j = 0; j < pointsInRing; j++) {
                    const angle = (j / pointsInRing) * 2 * Math.PI;
                    points.push({
                        dist: distKm,
                        lat: city.lat + (distKm * Math.cos(angle)) * latPerKm,
                        lon: city.lon + (distKm * Math.sin(angle)) * lonPerKm
                    });
                }
            }

            let totalWeight = 0;
            points.forEach(p => {
                p.weight = Math.exp(- (p.dist * p.dist) / (2 * sigma * sigma));
                totalWeight += p.weight;
            });

            points.forEach(p => {
                populationNodes.push({
                    name: city.name,
                    type: 'urban',
                    lat: p.lat,
                    lon: p.lon,
                    pop: city.pop * (p.weight / totalWeight)
                });
            });
        });
    }

    generateGaussianHybridMesh();

    // --- ãƒãƒƒãƒ—åˆæœŸåŒ– ---
    const map = L.map('map').setView([36.0, 138.0], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    infrastructures.forEach(infra => {
        let color = "gray";
        if(infra.type === "plant") color = "green";
        if(infra.type === "base") color = "blue";
        if(infra.type === "airport") color = "purple";
        if(infra.type === "government") color = "black";
        L.circleMarker([infra.lat, infra.lon], { radius: 4, color: color, fillOpacity: 0.8, weight: 1 }).addTo(map).bindTooltip(infra.name);
    });

    let targets = [];
    let mapCircles = [];
    let targetMarkers = [];
    let falloutLayers = [];

    map.on('click', function(e) {
        const yieldVal = parseFloat(document.getElementById('yieldInput').value);
        const burstType = document.querySelector('input[name="burstType"]:checked').value;
        addTarget(e.latlng.lat, e.latlng.lng, yieldVal, burstType);
    });

    function setYield(val) { document.getElementById('yieldInput').value = val; }

    function addTarget(lat, lon, yieldKt, type) {
        const targetData = { lat, lon, yield: yieldKt, type: type };
        targets.push(targetData);
        const marker = L.circleMarker([lat, lon], { radius: 8, color: 'red', fillColor: '#f00', fillOpacity: 1, weight: 2 }).addTo(map);
        marker.bindTooltip("å‰Šé™¤", {direction: 'top', offset: [0, -10]});
        marker.on('click', function(e) {
            L.DomEvent.stopPropagation(e);
            map.removeLayer(marker);
            const index = targets.indexOf(targetData);
            if (index > -1) targets.splice(index, 1);
            const mIndex = targetMarkers.indexOf(marker);
            if (mIndex > -1) targetMarkers.splice(mIndex, 1);
            updateCount();
            resetResults();
        });
        targetMarkers.push(marker);
        updateCount();
    }
    
    function updateCount() { document.getElementById('targetCount').innerText = targets.length; }
    function resetResults() {
        mapCircles.forEach(c => map.removeLayer(c)); mapCircles = [];
        falloutLayers.forEach(l => map.removeLayer(l)); falloutLayers = [];
        document.getElementById('results').style.display = 'none';
    }
    function clearTargets() {
        targets = [];
        targetMarkers.forEach(m => map.removeLayer(m)); targetMarkers = [];
        resetResults(); updateCount();
    }

    function getDistanceKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function calculateRadii(yieldKt, type) {
        const mod = (type === 'surface') ? 0.7 : 1.0;
        return {
            fireball: 1.45 * Math.pow(yieldKt / 1000, 0.4) * mod,
            heavyBlast: 0.28 * Math.pow(yieldKt, 0.333) * mod,     
            moderateBlast: 0.71 * Math.pow(yieldKt, 0.333) * mod,  
            thermal: 6.0 * Math.pow(yieldKt / 1000, 0.45) * mod 
        };
    }

    // ãƒãƒªã‚´ãƒ³å†…åˆ¤å®š (Ray Casting)
    function isPointInPolygon(point, vs) {
        var x = point[0], y = point[1];
        var inside = false;
        for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            var xi = vs[i][0], yi = vs[i][1];
            var xj = vs[j][0], yj = vs[j][1];
            var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    function simulate() {
        if (targets.length === 0) { alert("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"); return; }
        resetResults();

        const windDir = parseInt(document.getElementById('windDir').value);
        const isNoWind = document.getElementById('noWind').checked;
        const timeOfDay = document.querySelector('input[name="timeOfDay"]:checked').value;
        
        // æ˜¼å¤œè£œæ­£ä¿‚æ•°
        const urbanMod = (timeOfDay === 'day') ? 1.3 : 0.7;
        const ruralMod = (timeOfDay === 'day') ? 0.8 : 1.1;

        let falloutPolys = [];

        targets.forEach(t => {
            const radii = calculateRadii(t.yield, t.type);
            
            // å††æç”»
            const zones = [
                { r: radii.thermal, color: 'orange', opacity: 0.15 },
                { r: radii.moderateBlast, color: 'red', opacity: 0.2 },
                { r: radii.heavyBlast, color: 'purple', opacity: 0.3 },
                { r: radii.fireball, color: 'black', opacity: 0.5 }
            ];
            zones.forEach(z => {
                const c = L.circle([t.lat, t.lon], { color: z.color, fillColor: z.color, fillOpacity: z.opacity, radius: z.r * 1000, weight: 1 }).addTo(map);
                mapCircles.push(c);
            });

            // ãƒ•ã‚©ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ (Surfaceçˆ†ç™º ã¾ãŸã¯ >100kt ã‹ã¤ ç„¡é¢¨ã§ãªã„å ´åˆ)
            if ((t.type === 'surface' || t.yield > 100) && !isNoWind) {
                const falloutLen = 1.2 * Math.pow(t.yield, 0.45); 
                const falloutWid = falloutLen * 0.25;
                
                let polyPoints = [];
                const centerLat = t.lat; 
                const centerLon = t.lon;
                const steps = 36;
                const radDir = (windDir - 90) * (Math.PI / 180);

                for (let i = 0; i < steps; i++) {
                    const theta = (i / steps) * 2 * Math.PI;
                    const a = falloutLen; 
                    const b = falloutWid;
                    const localX = (a * Math.cos(theta) + a) / 2; 
                    const localY = (b * Math.sin(theta)) / 2;

                    const rotX = localX * Math.cos(radDir) - localY * Math.sin(radDir);
                    const rotY = localX * Math.sin(radDir) + localY * Math.cos(radDir);

                    const latOffset = rotY / 111.0;
                    const lonOffset = rotX / (111.0 * Math.cos(centerLat * Math.PI/180));
                    
                    polyPoints.push([centerLat + latOffset, centerLon + lonOffset]);
                }
                
                const pg = L.polygon(polyPoints, { color: 'gray', fillColor: '#333', fillOpacity: 0.3, weight: 0 }).addTo(map);
                falloutLayers.push(pg);
                falloutPolys.push(polyPoints);
            }
        });

        // è¢«å®³è¨ˆç®—
        let totalDead = 0;
        let totalInjured = 0;
        let falloutPop = 0;
        let areaReport = {};

        populationNodes.forEach(node => {
            const popMod = (node.type === 'urban') ? urbanMod : ruralMod;
            const currentPop = node.pop * popMod;

            let maxDeathRate = 0;
            let maxInjuredRate = 0;
            let isFallout = false;

            // 1. çˆ†é¢¨ãƒ»ç†±ç·š
            targets.forEach(t => {
                const dist = getDistanceKm(t.lat, t.lon, node.lat, node.lon);
                const radii = calculateRadii(t.yield, t.type);
                let dRate = 0; let iRate = 0;
                
                if (dist < radii.fireball) { dRate = 1.0; } 
                else if (dist < radii.heavyBlast) { dRate = 0.95; iRate = 0.05; } 
                else if (dist < radii.moderateBlast) { dRate = 0.50; iRate = 0.45; } 
                else if (dist < radii.thermal) { dRate = 0.15; iRate = 0.50; }

                if (dRate > maxDeathRate) { maxDeathRate = dRate; maxInjuredRate = iRate; } 
                else if (dRate === maxDeathRate && iRate > maxInjuredRate) { maxInjuredRate = iRate; }
            });

            // 2. ãƒ•ã‚©ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆåˆ¤å®š
            if (!isNoWind && maxDeathRate < 0.1) {
                for (let poly of falloutPolys) {
                    if (isPointInPolygon([node.lat, node.lon], poly)) {
                        isFallout = true;
                        break;
                    }
                }
            }

            if (maxDeathRate > 0 || maxInjuredRate > 0) {
                const dead = currentPop * maxDeathRate;
                const injured = currentPop * maxInjuredRate;
                totalDead += dead;
                totalInjured += injured;
                if (!areaReport[node.name]) areaReport[node.name] = {dead:0, type: node.type};
                areaReport[node.name].dead += dead;
            }

            if (isFallout) {
                falloutPop += currentPop;
            }
        });

        // ã‚¤ãƒ³ãƒ•ãƒ©è¢«å®³
        let infraDamageList = [];
        infrastructures.forEach(infra => {
            let status = "safe"; let causedBy = "";
            for(let t of targets) {
                const dist = getDistanceKm(t.lat, t.lon, infra.lat, infra.lon);
                const radii = calculateRadii(t.yield, t.type);
                if (dist < radii.heavyBlast) { status = "destroyed"; causedBy = "å®Œå…¨ç ´å£Š"; break; } 
                else if (dist < radii.moderateBlast) { if(status!=="destroyed"){ status = "damaged"; causedBy = "ç”šå¤§è¢«å®³"; } }
            }
            if (status !== "safe") infraDamageList.push({ name: infra.name, status: status, desc: causedBy });
        });

        // è¡¨ç¤º
        document.getElementById('results').style.display = 'block';
        document.getElementById('deadCount').innerText = Math.round(totalDead).toLocaleString();
        document.getElementById('injuredCount').innerText = Math.round(totalInjured).toLocaleString();
        document.getElementById('falloutPop').innerText = Math.round(falloutPop).toLocaleString();

        const infraElem = document.getElementById('infraList');
        infraElem.innerHTML = "";
        if(infraDamageList.length > 0) {
            infraDamageList.forEach(infra => {
                const div = document.createElement('div');
                div.className = "list-item";
                const colorClass = infra.status === "destroyed" ? "infra-destroyed" : "infra-damaged";
                div.innerHTML = `<span>${infra.name}</span> <span class="${colorClass}">${infra.desc}</span>`;
                infraElem.appendChild(div);
            });
        } else { infraElem.innerHTML = "<div class='list-item'>è¢«å®³ãªã—</div>"; }

        const areaElem = document.getElementById('hitAreas');
        areaElem.innerHTML = "";
        const sortedAreas = Object.keys(areaReport).sort((a,b) => areaReport[b].dead - areaReport[a].dead);
        if(sortedAreas.length > 0) {
            sortedAreas.slice(0, 15).forEach(area => {
                const d = areaReport[area];
                const div = document.createElement('div');
                div.className = "list-item";
                const style = d.type === 'urban' ? 'font-weight:bold;' : 'color:#666; font-size:0.75rem;';
                div.innerHTML = `<span style="${style}">${area}</span> <span>æ­»è€…: ${Math.round(d.dead).toLocaleString()}</span>`;
                areaElem.appendChild(div);
            });
        } else { areaElem.innerHTML = "<div class='list-item'>è¢«å®³ãªã—</div>"; }
    }
</script>
</body>
</html>