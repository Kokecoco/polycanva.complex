<!DOCTYPE html>
<html>
<head>
    <title>ブラウザAI迷言ジェネレーター (翻訳版)</title>
</head>
<body>
    <h1>今日のAI迷言</h1>
    <p id="meigen-output">ボタンを押して生成してください</p>
    <button id="generate-button">新しい迷言を生成する</button>

    <!-- Transformers.jsを読み込む -->
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

        const outputElement = document.getElementById('meigen-output');
        const generateButton = document.getElementById('generate-button');

        // ★★★ ステップ1でコピーしたあなたのGASウェブアプリのURLをここに貼り付け ★★★
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzPJS6reXcVq0YlWijAVtcmDJ4NGOoABhi1yWOso0V9Bg57rNI5zI54ZX0w2O5M0YT3/exec";

        // 準備（一度だけ実行）
        outputElement.textContent = "AIの準備をしています...";
        const generator = await pipeline('text-generation', 'Xenova/distilgpt2');
        outputElement.textContent = "準備完了！ボタンを押してください";

        async function generateAndTranslate() {
            generateButton.disabled = true;

            try {
                // --- 1. 英語のテキストを生成 ---
                outputElement.textContent = "英語で迷言を考えています...";
                const prompt = "A funny philosophical quote is, \"";
                const englishResult = await generator(prompt, {
                    max_new_tokens: 30,
                    return_full_text: false, // プロンプトを含めない
                });
                const englishText = englishResult[0].generated_text;

                // --- 2. GASの翻訳APIにリクエスト ---
                outputElement.textContent = "Google翻訳で日本語にしています...";
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // GASのdoPostはtext/plainでも受け取れる
                    body: JSON.stringify({ text: englishText }),
                });
                
                if (!response.ok) {
                    throw new Error(`翻訳APIエラー: ${response.status}`);
                }

                const translationResult = await response.json();
                
                // --- 3. 最終結果を表示 ---
                outputElement.textContent = translationResult.translated_text;

            } catch (error) {
                console.error("エラーが発生しました:", error);
                outputElement.textContent = `エラーが発生しました。${error.message}`;
            } finally {
                generateButton.disabled = false;
            }
        }

        generateButton.addEventListener('click', generateAndTranslate);
    </script>
</body>
</html>
