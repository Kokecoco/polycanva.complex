<!DOCTYPE html>
<html>
<head>
    <title>ブラウザAI名言ジェネレーター (GAS連携版)</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; }
        h1 { font-size: 1.8em; }
        button { font-size: 1em; padding: 10px 15px; cursor: pointer; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        #result-container { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result-box { margin-top: 10px; }
        .result-box h3 { margin: 0 0 5px 0; font-size: 1em; color: #555; }
        .result-box p { margin: 0; padding: 10px; background-color: #f4f4f4; border-radius: 3px; min-height: 1.2em;}
    </style>
</head>
<body>
    <h1>今日のAI名言</h1>
    <button id="generate-button" type="button">新しい名言を生成する</button>

    <div id="result-container">
        <div class="result-box">
            <h3>原文 (English)</h3>
            <p id="original-text">-</p>
        </div>
        <div class="result-box">
            <h3>翻訳 (Japanese)</h3>
            <p id="translated-text">ボタンを押して生成してください</p>
        </div>
    </div>

    <!-- ▼▼▼ デバッグ用インスペクタ（ログ表示）のコード ▼▼▼ -->
    <div id="dev-log-panel" style="position: fixed; bottom: 10px; right: 10px; width: 400px; height: 300px; background: rgba(0,0,0,0.8); color: white; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; font-family: monospace; font-size: 12px; z-index: 9999; display: block;"><div style="padding-bottom: 5px; border-bottom: 1px solid #555; font-weight: bold;">デバッグログ</div><pre id="dev-log-content"></pre></div>
    <script>
      function logToPanel(message, isError = false) { const logContent = document.getElementById('dev-log-content'); if (logContent) { const coloredMessage = isError ? `<span style="color: #ff8a8a;">${message}</span>` : message; logContent.innerHTML += coloredMessage.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '\n\n'; const logPanel = document.getElementById('dev-log-panel'); logPanel.scrollTop = logPanel.scrollHeight; } }
      window.onerror = function(message, source, lineno, colno, error) { logToPanel(`[JS Error]\n  メッセージ: ${message}\n  ファイル: ${source}\n  行: ${lineno}, 列: ${colno}`, true); }; window.onunhandledrejection = function(event) { logToPanel(`[JS Promise Error]\n  理由: ${event.reason}`, true); };
      try { const observer = new PerformanceObserver((list) => { list.getEntries().forEach((entry) => { if (entry.initiatorType === 'fetch') {logToPanel(`[リソース監視]\n  ファイル: ${entry.name}\n  読込時間: ${entry.duration.toFixed(2)}ms`);} }); }); observer.observe({ type: "resource", buffered: true }); } catch(e) { console.warn("PerformanceObserver is not supported."); }
      const originalFetch = window.fetch; window.fetch = function() { const [url, options] = arguments; logToPanel(`[Fetch APIリクエスト]\n  URL: ${url}\n  Method: ${options ? options.method || 'GET' : 'GET'}`); return originalFetch.apply(this, arguments).then(async (response) => { const resClone = response.clone(); logToPanel(`[Fetch APIレスポンス]\n  URL: ${resClone.url}\n  Status: ${resClone.status} ${resClone.statusText}`); return response; }).catch((error) => { logToPanel(`[Fetch APIエラー]\n  URL: ${url}\n  エラー: ${error}`, true); throw error; }); };
    </script>
    <!-- ▲▲▲ インスペクタ用のコード ▲▲▲ -->

    <!-- ▼▼▼ アプリケーション本体のコード ▼▼▼ -->
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

        const originalTextElement = document.getElementById('original-text');
        const translatedTextElement = document.getElementById('translated-text');
        const generateButton = document.getElementById('generate-button');

        // ★★★★★ 重要 ★★★★★
        // 以下のURLを、あなたがデプロイしたGoogle Apps ScriptのURLに書き換えてください。
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbynue36OhjVX1uhdZr9iK1vq1oRwZV0V8N56tLrY7vMH66aesO04hTcg4rbr5QFR59L7Q/exec";

        /**
         * GASの翻訳APIを呼び出し、英語のテキストを日本語に翻訳します。
         * @param {string} englishText - 翻訳したい英語のテキスト。
         * @returns {Promise<string>} - 翻訳された日本語のテキストを返します。
         * @throws {Error} - APIからのレスポンスがエラーの場合や、ネットワークエラーが発生した場合にエラーをスローします。
         */
        async function translateEnglishToJapanese(englishText) {
            // GASウェブアプリのURLが設定されているかチェック
            if (GAS_API_URL === "GASのURLを指定してください。") {
                throw new Error("GAS_API_URLが設定されていません。コード内のURLをあなたのウェブアプリのURLに書き換えてください。");
            }
            
            // APIに渡すパラメータを組み立てる
            const params = new URLSearchParams({
                text: englishText,
                source: 'en', // 翻訳元言語（英語）
                target: 'ja', // 翻訳先言語（日本語）
            });

            // GETリクエストを送信するURLを作成
            const requestUrl = `${GAS_API_URL}?${params.toString()}`;

            const response = await fetch(requestUrl);

            if (!response.ok) {
                throw new Error(`ネットワークエラー: HTTPステータス ${response.status}`);
            }
            
            const data = await response.json();
            logToPanel(`[GAS APIレスポンスBody]\n  ${JSON.stringify(data, null, 2)}`); // レスポンス内容をログに出力

            if (data.code === 200) {
                return data.text; // 成功した場合は翻訳結果のテキストを返す
            } else {
                throw new Error(`GAS APIからのエラー: ${data.text}`);
            }
        }


        // AIモデルの準備
        async function initialize() {
            try {
                translatedTextElement.textContent = "AIの準備をしています... (初回は少し時間がかかります)";
                const generator = await pipeline('text-generation', 'Xenova/opt-350m');
                translatedTextElement.textContent = "準備完了！ボタンを押してください";
                // グローバルスコープで利用できるようにする
                window.generator = generator;
            } catch (error) {
                translatedTextElement.textContent = `AIモデルの初期化に失敗しました。詳細は右下のログを確認してください。`;
                console.error("詳細なエラー情報:", error);
                logToPanel(`[AI初期化エラー] ${error.message}`, true);
            }
        }
        
        // ボタンがクリックされた時の処理
        async function generateAndTranslate() {
            if (!window.generator) {
                translatedTextElement.textContent = `AIが準備できていません。ページを再読み込みしてください。`;
                return;
            }

            generateButton.disabled = true;
            originalTextElement.textContent = "-";
            translatedTextElement.textContent = "英語で名言を考えています...";

            try {
                // 英語でテキストを生成
                const prompt = "Generate a single, deep, and witty quote about life:";
                const englishResult = await window.generator(prompt, {
                    max_new_tokens: 30, return_full_text: false, do_sample: true, temperature: 0.7,
                });
                
                let englishText = englishResult[0].generated_text.split('"')[0].trim();
                originalTextElement.textContent = englishText;
                translatedTextElement.textContent = "Google翻訳で日本語にしています...";

                // ★★★★★ 修正点 ★★★★★
                // 先ほど定義した、GETリクエストを送信する関数を呼び出すように変更
                const japaneseText = await translateEnglishToJapanese(englishText);
                translatedTextElement.textContent = japaneseText;

            } catch (error) {
                translatedTextElement.textContent = `エラーが発生しました。詳細は右下のログを確認してください。`;
                console.error("詳細なエラー情報:", error);
                // エラーオブジェクト全体ではなく、メッセージをログに出力する
                logToPanel(`[処理エラー] ${error.message}`, true);
            } finally {
                generateButton.disabled = false;
            }
        }

        // 初期化処理を実行
        initialize();
        // イベントリスナーを登録
        generateButton.addEventListener('click', generateAndTranslate);
    </script>
</body>
</html>
