<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniDrop</title>
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 10px; background: #fafafa; color: #333; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #007bff; }
        
        /* ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .btn { padding: 12px 24px; font-size: 16px; margin: 8px; cursor: pointer; border: none; border-radius: 8px; transition: 0.2s; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* ã‚¨ãƒªã‚¢åˆ¶å¾¡ */
        .hidden { display: none !important; }
        .step-box { border: 2px dashed #ccc; padding: 15px; margin: 15px 0; border-radius: 8px; background: #f9f9f9; }
        
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #guide-text { background: #e7f3ff; padding: 10px; border-radius: 5px; font-size: 0.9rem; text-align: left; margin-bottom: 15px;}
        textarea { width: 100%; height: 60px; font-size: 10px; margin-top: 5px; border: 1px solid #ddd; }
        
        /* ã‚«ãƒ¡ãƒ©ãƒ»QR */
        #video-area { position: relative; width: 100%; max-width: 400px; margin: 0 auto; overflow: hidden; border-radius: 8px; }
        video { width: 100%; background: black; }
        canvas { display: none; }
        #qr-display { display: flex; justify-content: center; margin: 10px 0; }
        
        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        #progress-container { width: 100%; background-color: #eee; height: 20px; border-radius: 10px; margin-top: 10px; overflow: hidden; display: none; }
        #progress-bar { width: 0%; height: 100%; background-color: #28a745; transition: width 0.2s; }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ */
        .file-item { background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; text-align: left; }
        .download-link { color: #007bff; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>OmniDrop</h2>

    <!-- ã‚·ãƒ¼ãƒ³é¸æŠ -->
    <div id="scene-selection">
        <p>ç¾åœ¨ã®æ¥ç¶šçŠ¶æ³ã‚’é¸ã‚“ã§ãã ã•ã„</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button class="btn btn-secondary" onclick="selectScene('wifi')">ğŸ  åŒã˜Wi-Fiã«ã„ã‚‹</button>
            <button class="btn btn-secondary" onclick="selectScene('tethering')">ğŸ“± ãƒ†ã‚¶ãƒªãƒ³ã‚°ä¸­</button>
        </div>
    </div>

    <!-- ã‚¬ã‚¤ãƒ‰è¡¨ç¤º -->
    <div id="guide-area" class="hidden">
        <div id="guide-text"></div>
        <hr>
        <p>ã‚ãªãŸã®å½¹å‰²ã¯ï¼Ÿ</p>
        <button class="btn btn-primary" onclick="startAsSender()">ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ã‚‹</button>
        <button class="btn btn-success" onclick="startAsReceiver()">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚‹</button>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status-area" class="hidden">
        <p id="status-text" style="font-weight: bold;">æº–å‚™ä¸­...</p>
    </div>

    <!-- Step 1: QRè¡¨ç¤º (è‡ªåˆ†ã®æƒ…å ±ã‚’ç›¸æ‰‹ã«è¦‹ã›ã‚‹) -->
    <div id="step-show-qr" class="step-box hidden">
        <h3>Step 1: ç›¸æ‰‹ã«è¦‹ã›ã¦ãã ã•ã„</h3>
        <div id="qr-display"></div>
        <p style="font-size:0.8rem; color:#666;">QRãŒèª­ã¿å–ã‚Œãªã„å ´åˆã¯ã€ä¸‹ã®æ–‡å­—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦é€ã£ã¦ãã ã•ã„</p>
        <textarea id="local-sdp" readonly onclick="this.select()"></textarea>
    </div>

    <!-- Step 2: ã‚«ãƒ¡ãƒ©èµ·å‹• (ç›¸æ‰‹ã®æƒ…å ±ã‚’èª­ã‚€) -->
    <div id="step-scan-qr" class="step-box hidden">
        <h3>Step 2: ç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹</h3>
        <p id="scan-instruction">ç›¸æ‰‹ã®ç”»é¢ã«å‡ºã¦ããŸQRã‚³ãƒ¼ãƒ‰ã‚’æ˜ ã—ã¦ãã ã•ã„</p>
        <button class="btn btn-secondary" onclick="startScan()">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
        <div id="video-area">
            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        <details>
            <summary>ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆãªã„å ´åˆ</summary>
            <textarea id="remote-sdp-input" placeholder="ç›¸æ‰‹ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
            <button class="btn btn-secondary" onclick="manualPaste()">æ¥ç¶š</button>
        </details>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ç”»é¢ -->
    <div id="transfer-ui" class="hidden">
        <h3>ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«é€å—ä¿¡</h3>
        
        <!-- é€ä¿¡å´UI -->
        <div id="sender-controls" class="hidden">
            <input type="file" id="fileInput">
            <button class="btn btn-primary" onclick="sendFile()">é€ä¿¡é–‹å§‹</button>
        </div>

        <!-- å—ä¿¡å´UI -->
        <div id="receiver-controls" class="hidden">
            <p>ç›¸æ‰‹ã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            <div id="received-files"></div>
        </div>

        <!-- é€²æ—ãƒãƒ¼ -->
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>
</div>

<script>
    // --- è¨­å®šãƒ»å¤‰æ•° ---
    let peerConnection;
    let dataChannel;
    let role = ''; // 'sender' or 'receiver'
    
    // ãƒ­ãƒ¼ã‚«ãƒ«P2Pã®ã¿è¨±å¯ã™ã‚‹è¨­å®š (STUNã‚µãƒ¼ãƒãƒ¼ãªã—)
    const rtcConfig = { 
        iceServers: [] 
    };

    // --- UIåˆ¶å¾¡ ---
    function selectScene(type) {
        const guideText = document.getElementById('guide-text');
        const guideArea = document.getElementById('guide-area');
        
        if (type === 'wifi') {
            guideText.innerHTML = `
                <b>âœ… Wi-Fiãƒ¢ãƒ¼ãƒ‰:</b><br>
                ä¸¡æ–¹ã®ã‚¹ãƒãƒ›ãŒ<b>ã€ŒåŒã˜Wi-Fiãƒ«ãƒ¼ã‚¿ãƒ¼ã€</b>ã«æ¥ç¶šã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
                â€»ç•°ãªã‚‹Wi-Fiï¼ˆä¾‹: 2.4GHzã¨5GHzã§éš”é›¢ã•ã‚Œã¦ã„ã‚‹å ´åˆãªã©ï¼‰ã ã¨ç¹‹ãŒã‚‰ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
            `;
        } else {
            guideText.innerHTML = `
                <b>âœ… ãƒ†ã‚¶ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰:</b><br>
                ç‰‡æ–¹ã®ã‚¹ãƒãƒ›ã§<b>ã€Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…±æœ‰ï¼ˆãƒ†ã‚¶ãƒªãƒ³ã‚°ï¼‰ã€</b>ã‚’ONã«ã—ã€<br>
                ã‚‚ã†ç‰‡æ–¹ãŒ<b>ãã®Wi-Fiã«æ¥ç¶š</b>ã—ã¦ãã ã•ã„ã€‚<br>
                â€»ã‚®ã‚¬ã‚’æ¶ˆè²»ã—ãªã„ã‚ˆã†ã€è¦ªæ©Ÿã¯ã€Œãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿é€šä¿¡ã€ã‚’OFFã«ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
            `;
        }
        
        document.getElementById('scene-selection').classList.add('hidden');
        guideArea.classList.remove('hidden');
    }

    function showStatus(msg) {
        document.getElementById('status-area').classList.remove('hidden');
        document.getElementById('status-text').textContent = msg;
    }

    // --- WebRTC åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ ---
    function initPeerConnection() {
        const pc = new RTCPeerConnection(rtcConfig);

        // ICE Candidateï¼ˆæ¥ç¶šçµŒè·¯æƒ…å ±ï¼‰ãŒè¦‹ã¤ã‹ã£ãŸã‚‰
        pc.onicecandidate = event => {
            if (event.candidate === null) {
                // åé›†å®Œäº† -> SDPã‚’åœ§ç¸®ã—ã¦QRè¡¨ç¤º
                const sdpData = JSON.stringify(pc.localDescription);
                const compressed = LZString.compressToBase64(sdpData);
                generateQRCode(compressed);
                document.getElementById('local-sdp').value = compressed;
                showStatus("æ¥ç¶šæƒ…å ±ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã«è¦‹ã›ã¦ãã ã•ã„ã€‚");
            }
        };

        // æ¥ç¶šçŠ¶æ…‹ã®å¤‰åŒ–
        pc.onconnectionstatechange = () => {
            showStatus(`æ¥ç¶šçŠ¶æ…‹: ${pc.connectionState}`);
            if (pc.connectionState === 'connected') {
                document.getElementById('step-show-qr').classList.add('hidden');
                document.getElementById('step-scan-qr').classList.add('hidden');
                document.getElementById('status-area').classList.add('hidden');
                document.getElementById('transfer-ui').classList.remove('hidden');
            }
        };

        return pc;
    }

    // --- é€ä¿¡å´ã®é–‹å§‹ãƒ•ãƒ­ãƒ¼ ---
    async function startAsSender() {
        role = 'sender';
        document.getElementById('guide-area').classList.add('hidden');
        document.getElementById('sender-controls').classList.remove('hidden');
        document.getElementById('step-show-qr').classList.remove('hidden'); // ã¾ãšQRã‚’è¦‹ã›ã‚‹
        showStatus("æ¥ç¶šçµŒè·¯ã‚’æ¢ã—ã¦ã„ã¾ã™...");

        peerConnection = initPeerConnection();
        
        // ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«ä½œæˆ (é€ä¿¡å´ã®ã¿)
        dataChannel = peerConnection.createDataChannel("fileTransfer");
        setupDataChannelEvents(dataChannel);

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
    }

    // --- å—ä¿¡å´ã®é–‹å§‹ãƒ•ãƒ­ãƒ¼ ---
    async function startAsReceiver() {
        role = 'receiver';
        document.getElementById('guide-area').classList.add('hidden');
        document.getElementById('receiver-controls').classList.remove('hidden');
        document.getElementById('step-scan-qr').classList.remove('hidden'); // ã¾ãšã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
        showStatus("ç›¸æ‰‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");

        peerConnection = initPeerConnection();
        
        // ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«å—ã‘å–ã‚Šå¾…æ©Ÿ
        peerConnection.ondatachannel = event => {
            setupDataChannelEvents(event.channel);
        };
    }

    // --- ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ« (é€å—ä¿¡å…±é€šå‡¦ç†) ---
    let incomingFileInfo = null;
    let incomingFileBuffer = [];
    let receivedSize = 0;

    function setupDataChannelEvents(channel) {
        dataChannel = channel;
        dataChannel.onopen = () => {
            showStatus("P2Pæ¥ç¶šå®Œäº†ï¼");
            // ã‚¹ãƒ†ãƒƒãƒ—UIã‚’å®Œå…¨ã«éš ã™
            document.getElementById('step-show-qr').classList.add('hidden');
            document.getElementById('step-scan-qr').classList.add('hidden');
        };

        dataChannel.onmessage = event => {
            const data = event.data;
            
            if (typeof data === 'string') {
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å—ä¿¡
                incomingFileInfo = JSON.parse(data);
                incomingFileBuffer = [];
                receivedSize = 0;
                document.getElementById('progress-container').style.display = 'block';
                showStatus(`å—ä¿¡ä¸­: ${incomingFileInfo.name}`);
            } else {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿å—ä¿¡
                incomingFileBuffer.push(data);
                receivedSize += data.byteLength;
                updateProgress(receivedSize, incomingFileInfo.size);

                if (receivedSize >= incomingFileInfo.size) {
                    // å®Œäº†
                    const blob = new Blob(incomingFileBuffer);
                    const url = URL.createObjectURL(blob);
                    
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `
                        <div><b>${incomingFileInfo.name}</b> (${formatSize(incomingFileInfo.size)})</div>
                        <a href="${url}" download="${incomingFileInfo.name}" class="download-link">ğŸ’¾ ä¿å­˜ã™ã‚‹</a>
                    `;
                    document.getElementById('received-files').appendChild(div);
                    showStatus("å—ä¿¡å®Œäº†");
                    document.getElementById('progress-container').style.display = 'none';
                }
            }
        };
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡å‡¦ç† ---
    async function sendFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file || dataChannel.readyState !== 'open') return;

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹
        dataChannel.send(JSON.stringify({ name: file.name, size: file.size }));
        
        document.getElementById('progress-container').style.display = 'block';
        const buffer = await file.arrayBuffer();
        const CHUNK_SIZE = 16384; // 16KB
        let offset = 0;

        // ãƒãƒƒãƒ•ã‚¡æº¢ã‚Œã‚’é˜²ããªãŒã‚‰é€ä¿¡
        const sendLoop = setInterval(() => {
            if (dataChannel.bufferedAmount > 1000000) return; // ãƒãƒƒãƒ•ã‚¡ãŒã„ã£ã±ã„ãªã‚‰å¾…ã¤

            if (offset >= buffer.byteLength) {
                clearInterval(sendLoop);
                showStatus("é€ä¿¡å®Œäº†");
                document.getElementById('progress-container').style.display = 'none';
                return;
            }

            const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
            dataChannel.send(chunk);
            offset += CHUNK_SIZE;
            updateProgress(offset, file.size);
        }, 5); // é€ä¿¡é–“éš”
    }

    function updateProgress(current, total) {
        const percent = Math.min((current / total) * 100, 100);
        document.getElementById('progress-bar').style.width = percent + '%';
    }

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // --- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ ---
    function generateQRCode(text) {
        const container = document.getElementById('qr-display');
        container.innerHTML = "";
        try {
            new QRCode(container, {
                text: text,
                width: 250,
                height: 250,
                correctLevel: QRCode.CorrectLevel.L // ãƒ‡ãƒ¼ã‚¿é‡ã‚’æ¸›ã‚‰ã™ãŸã‚ä½ãƒ¬ãƒ™ãƒ«è£œæ­£
            });
        } catch(e) {
            container.textContent = "ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã™ãã¦QRã‚³ãƒ¼ãƒ‰åŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚";
        }
    }

    // --- ã‚«ãƒ¡ãƒ©èª­ã¿å–ã‚Šé–¢é€£ ---
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let isScanning = false;

    function startScan() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                video.srcObject = stream;
                video.setAttribute("playsinline", true); // iOSå¯¾å¿œ
                video.play();
                isScanning = true;
                requestAnimationFrame(scanTick);
            })
            .catch(err => {
                alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚HTTPSã§æ¥ç¶šã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n" + err.name);
            });
    }

    function scanTick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code) {
                isScanning = false;
                video.srcObject.getTracks().forEach(t => t.stop()); // ã‚«ãƒ¡ãƒ©åœæ­¢
                handleScannedData(code.data);
                return;
            }
        }
        if (isScanning) requestAnimationFrame(scanTick);
    }

    function manualPaste() {
        const text = document.getElementById('remote-sdp-input').value;
        if(text) handleScannedData(text);
    }

    // --- èª­ã¿å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ ---
    function handleScannedData(compressedData) {
        try {
            const sdpStr = LZString.decompressFromBase64(compressedData);
            if (!sdpStr) throw new Error("Decompress failed");
            const desc = JSON.parse(sdpStr);
            
            processRemoteDescription(desc);
        } catch(e) {
            alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    }

    async function processRemoteDescription(desc) {
        await peerConnection.setRemoteDescription(desc);

        if (role === 'receiver' && desc.type === 'offer') {
            // å—ä¿¡å´ï¼šOfferã‚’å—ã‘å–ã£ãŸ -> Answerã‚’ç”Ÿæˆ -> Stepã‚’åˆ‡ã‚Šæ›¿ãˆ
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            // UIåˆ‡ã‚Šæ›¿ãˆ: ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã‚’éš ã—ã€QRè¡¨ç¤ºç”»é¢ã‚’å‡ºã™
            document.getElementById('step-scan-qr').classList.add('hidden');
            document.getElementById('step-show-qr').classList.remove('hidden');
            showStatus("è¿”ç­”ç”¨QRã‚’ç”Ÿæˆä¸­...ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„");
            
            // onicecandidate ã§QRãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
            
        } else if (role === 'sender' && desc.type === 'answer') {
            // é€ä¿¡å´ï¼šAnswerã‚’å—ã‘å–ã£ãŸ -> æ¥ç¶šå®Œäº†å¾…ã¡
            showStatus("ç›¸æ‰‹ã®å¿œç­”ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚æ¥ç¶šç¢ºç«‹ä¸­...");
        }
    }
</script>

</body>
</html>
